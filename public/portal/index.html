<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Financial Dashboard Portal</title>
  <style>
    :root { --bg:#f6f8fb; --card:#fff; --text:#111827; --muted:#6b7280; --border:#e5e7eb; --primary:#2563eb; }
    *{ box-sizing:border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif; background:var(--bg); color:var(--text); }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 24px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin:0 0 16px; }
    h1 { margin:0; font-size:1.5rem; }
    .muted { color: var(--muted); }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(360px, 1fr)); gap: 20px; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:20px; box-shadow: 0 8px 20px rgba(0,0,0,.06); display:flex; flex-direction:column; gap:12px; min-height:320px; }
    .title { font-weight:600; font-size:1.1rem; }
    .badge { display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border:1px solid var(--border); border-radius:999px; font-size:.85rem; color:#111827; background:#fff; }
    .actions { margin-top:auto; display:flex; flex-wrap:wrap; gap:8px; }
    a.btn, button.btn { display:inline-block; background:var(--primary); color:#fff; text-decoration:none; border-radius:8px; padding:8px 12px; border:none; cursor:pointer; font-size:.9rem; white-space:nowrap; }
    a.btn.ghost, button.btn.ghost { background:#fff; color:#111827; border:1px solid var(--border); }
    label.btn.ghost { margin:0; }
    .dataset-select { padding:4px 8px; border:1px solid var(--border); border-radius:6px; font-size:.85rem; max-width:100%; }
    footer { margin-top:18px; color:var(--muted); font-size:.9rem; }
    @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } .card { min-height:auto; } }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Financial Dashboard Portal</h1>
        <div class="muted">Kies een rekening om te starten</div>
      </div>
      <div>
        <a class="btn ghost" href="/reports/unified_dashboard.html">Naar Unified Dashboard</a>
      </div>
    </header>

    <div id="cards" class="grid" role="list"></div>

    <section style="margin-top:18px;">
      <details>
        <summary><strong>Datasets beheren</strong> â€“ kies een bestand of upload een nieuwe</summary>
        <div style="margin-top:10px; display:flex; gap:10px; align-items:center;">
          <label for="global-dataset">Beschikbare datasets:</label>
          <select id="global-dataset"></select>
          <button id="refresh-datasets" class="btn ghost" type="button">Ververs</button>
          <input id="upload-input" type="file" accept=".csv,.tsv,.tab,.txt,.json" />
          <button id="upload-btn" class="btn" type="button">Upload</button>
          <span id="upload-msg" class="muted"></span>
        </div>
      </details>
    </section>

    <footer>
      <span>Last updated: <span id="ts"></span></span>
    </footer>
  </div>

  <script>
    document.getElementById('ts').textContent = new Date().toLocaleString('nl-NL');

    let DATASETS = [];

    async function fetchDatasets(){
      try{
  // Optional account-specific list: if a ?account=<ID> query is present, pass it through
  const r = await fetch('/data/list', { cache:'no-store' });
        if(!r.ok) throw new Error('HTTP '+r.status);
        const j = await r.json();
        DATASETS = j.files || [];
        const sel = document.getElementById('global-dataset');
        sel.innerHTML = '<option value="">(kies bestand)</option>' + DATASETS.map(f => `<option value="${f.path}">${f.name}</option>`).join('');
      }catch(e){
        DATASETS = [];
        document.getElementById('global-dataset').innerHTML = '<option value="">(geen gegevens)</option>';
      }
    }

    async function loadAccounts(){
      try{
        const res = await fetch('/config/accounts.json', { cache:'no-store' });
        if(!res.ok) throw new Error('HTTP '+res.status);
        const cfg = await res.json();
        const list = Array.isArray(cfg.accounts) ? cfg.accounts : [];
        const el = document.getElementById('cards');
        el.innerHTML = list.map(acc => {
          const q = new URLSearchParams();
          q.set('accounts', acc.id);
          if (acc.defaultData) q.set('data', acc.defaultData);
          // Use bank-specific dashboard if available, otherwise unified
          const dashboardUrl = acc.dashboardPath || '/reports/unified_dashboard.html';
          const href = dashboardUrl + (dashboardUrl.includes('?') ? '&' : '?') + q.toString();
          const accept = (Array.isArray(acc.allowedExt) && acc.allowedExt.length)
            ? acc.allowedExt.join(',')
            : '.csv,.tsv,.tab,.txt,.json';
          return `
            <article class="card" role="listitem" aria-label="${acc.label}">
              <div class="title">${acc.label}</div>
              <div class="badge" title="Valuta">ðŸ’¶ ${acc.currency || 'EUR'}</div>
              <label class="muted" style="font-size:.85rem;">Dataset
                <select data-acc="${acc.id}" class="dataset-select" style="margin-left:6px;">
                  ${acc.defaultData ? `<option value="${acc.defaultData}">(standaard) ${acc.defaultData.split('/').pop()}</option>` : ''}
                </select>
              </label>
              <div class="actions">
                <a class="btn" href="${dashboardUrl}">Open dashboard</a>
                <a class="btn ghost" href="${href}&savings=on" title="Open met spaardoelen">Open (savings)</a>
                <button class="btn ghost open-selected" data-acc="${acc.id}" data-dashboard="${dashboardUrl}" type="button">Open met gekozen bestand</button>
                <label class="btn ghost" style="cursor:pointer;">
                  <input type="file" data-upload-for="${acc.id}" accept="${accept}" style="display:none;" />
                  Upload voor ${acc.id}
                </label>
              </div>
            </article>`;
        }).join('') || '<div class="muted">Geen accounts geconfigureerd.</div>';

        // populate per-card selects with global and account-specific datasets
        async function populateForAccount(acc){
          const sel = document.querySelector(`select.dataset-select[data-acc="${acc.id}"]`);
          if (!sel) return;
          const current = sel.value;
          // clear any previous optgroups (keep default/top option)
          [...sel.querySelectorAll('optgroup')].forEach(g => g.remove());
          // global
          const globalGroup = document.createElement('optgroup');
          globalGroup.label = 'Globaal';
          globalGroup.innerHTML = DATASETS.map(f => `<option value="${f.path}">${f.name}</option>`).join('');
          sel.appendChild(globalGroup);
          // account-specific uploads
          try{
            const r = await fetch('/data/list?account=' + encodeURIComponent(acc.id), { cache:'no-store' });
            if (r.ok){
              const j = await r.json();
              const accGroup = document.createElement('optgroup');
              accGroup.label = acc.id + ' uploads';
              accGroup.innerHTML = (j.files||[]).map(f => `<option value="${f.path}">${f.name}</option>`).join('');
              sel.appendChild(accGroup);
            }
          }catch{}
          if (current) sel.value = current;
        }
        await Promise.all(list.map(populateForAccount));
        // wire open-selected buttons
        document.querySelectorAll('.open-selected').forEach(btn => {
          btn.addEventListener('click', () => {
            const accId = btn.getAttribute('data-acc');
            const dashboardUrl = btn.getAttribute('data-dashboard') || '/reports/unified_dashboard.html';
            const sel = document.querySelector(`select.dataset-select[data-acc="${accId}"]`);
            const val = sel && sel.value;
            if(!val){ alert('Kies eerst een dataset.'); return; }
            const q = new URLSearchParams({ accounts: accId, data: val });
            window.location.href = dashboardUrl + '?' + q.toString();
          });
        });

        // per-account upload wiring
        document.querySelectorAll('input[type=file][data-upload-for]').forEach(inp => {
          inp.addEventListener('change', async () => {
            const accId = inp.getAttribute('data-upload-for');
            const file = inp.files && inp.files[0];
            if(!file) return;
            const fd = new FormData();
            fd.append('file', file);
            try{
              const r = await fetch('/upload?account=' + encodeURIComponent(accId), { method:'POST', body: fd });
              const j = await r.json();
              if(!j.ok) throw new Error(j.error || 'Upload mislukt');
              // refresh datasets and per-card list for this account
              await fetchDatasets();
              const sel = document.querySelector(`select.dataset-select[data-acc="${accId}"]`);
              if (sel){
                // rebuild optgroups so the new upload appears under the account group
                [...sel.querySelectorAll('optgroup')].forEach(g => g.remove());
                const globalGroup = document.createElement('optgroup');
                globalGroup.label = 'Globaal';
                globalGroup.innerHTML = DATASETS.map(f => `<option value="${f.path}">${f.name}</option>`).join('');
                sel.appendChild(globalGroup);
                try{
                  const r2 = await fetch('/data/list?account=' + encodeURIComponent(accId), { cache:'no-store' });
                  if (r2.ok){
                    const j2 = await r2.json();
                    const accGroup = document.createElement('optgroup');
                    accGroup.label = accId + ' uploads';
                    accGroup.innerHTML = (j2.files||[]).map(f => `<option value="${f.path}">${f.name}</option>`).join('');
                    sel.appendChild(accGroup);
                    // select the newest item (last in list)
                    if (j2.files && j2.files.length) sel.value = j2.files[j2.files.length-1].path;
                  }
                }catch{}
              }
              alert('GeÃ¼pload voor ' + accId + ': ' + j.path.split('/').pop());
            }catch(e){ alert(e.message); }
            inp.value = '';
          });
        });
      } catch(e){
        document.getElementById('cards').innerHTML = '<div class="muted">Kon accounts niet laden</div>';
      }
    }

    // Upload handler
    async function doUpload(){
      const inp = document.getElementById('upload-input');
      const msg = document.getElementById('upload-msg');
      const f = inp.files && inp.files[0];
      if(!f){ msg.textContent = 'Geen bestand gekozen'; return; }
      const fd = new FormData();
      fd.append('file', f);
      msg.textContent = 'Uploaden...';
      try{
        const r = await fetch('/upload', { method: 'POST', body: fd });
        const j = await r.json();
        if(!j.ok) throw new Error(j.error || 'Upload mislukt');
        msg.textContent = 'GeÃ¼pload: ' + (j.path.split('/').pop());
        await fetchDatasets();
      }catch(e){ msg.textContent = e.message; }
    }

    document.getElementById('refresh-datasets').addEventListener('click', fetchDatasets);
    document.getElementById('upload-btn').addEventListener('click', doUpload);

    // initial load
    fetchDatasets().then(loadAccounts);
  </script>
</body>
</html>
