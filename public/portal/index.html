<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Financial Dashboard Portal</title>
  <style>
    :root { --bg:#f6f8fb; --card:#fff; --text:#111827; --muted:#6b7280; --border:#e5e7eb; --primary:#2563eb; }
    *{ box-sizing:border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif; background:var(--bg); color:var(--text); }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 24px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin:0 0 16px; }
    h1 { margin:0; font-size:1.5rem; }
    .muted { color: var(--muted); }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(360px, 1fr)); gap: 20px; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:20px; box-shadow: 0 8px 20px rgba(0,0,0,.06); display:flex; flex-direction:column; gap:12px; min-height:320px; }
    .title { font-weight:600; font-size:1.1rem; }
    .badge { display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border:1px solid var(--border); border-radius:999px; font-size:.85rem; color:#111827; background:#fff; }
    .actions { margin-top:auto; display:flex; flex-wrap:wrap; gap:8px; }
    a.btn, button.btn { display:inline-block; background:var(--primary); color:#fff; text-decoration:none; border-radius:8px; padding:8px 12px; border:none; cursor:pointer; font-size:.9rem; white-space:nowrap; }
    a.btn.ghost, button.btn.ghost { background:#fff; color:#111827; border:1px solid var(--border); }
    label.btn.ghost { margin:0; }
    .dataset-select { padding:4px 8px; border:1px solid var(--border); border-radius:6px; font-size:.85rem; max-width:100%; }
    footer { margin-top:18px; color:var(--muted); font-size:.9rem; }
    
    /* Savings section */
    .savings-section { margin-bottom: 32px; }
    .savings-total-wrapper { margin-bottom: 16px; }
    .savings-subcards { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; }
    .savings-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; box-shadow: 0 4px 12px rgba(0,0,0,.05); }
    .savings-card.total { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; border: none; padding: 24px; }
    .savings-card.total .savings-card-header { justify-content: center; margin-bottom: 16px; }
    .savings-card.total .savings-amount { text-align: center; font-size: 3rem; margin: 16px 0; }
    .savings-card.total .savings-last-updated { text-align: center; }
    .savings-card-header { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
    .savings-logo { width: 32px; height: 32px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 18px; background: #f3f4f6; }
    .savings-card.total .savings-logo { background: rgba(255,255,255,0.2); width: 40px; height: 40px; font-size: 24px; }
    .savings-title { font-weight: 600; font-size: 0.95rem; flex: 1; }
    .savings-card.total .savings-title { font-size: 1.4rem; }
    .savings-amount { font-size: 1.8rem; font-weight: 700; margin: 8px 0; }
    .savings-input { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 1.1rem; font-weight: 600; }
    .savings-last-updated { font-size: 0.75rem; opacity: 0.7; margin-top: 8px; }
    
    @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } .card { min-height:auto; } .savings-subcards { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Financial Dashboard Portal</h1>
        <div class="muted">Kies een rekening om te starten</div>
      </div>
      <div>
        <a class="btn ghost" href="/reports/unified_dashboard.html">Naar Unified Dashboard</a>
      </div>
    </header>

    <!-- Savings Overview Section -->
    <section class="savings-section">
      <h2 style="font-size: 1.3rem; margin-bottom: 12px;">Spaaroverzicht</h2>
      
      <!-- Total Card (Full Width) -->
      <div class="savings-total-wrapper">
        <div class="savings-card total">
          <div class="savings-card-header">
            <div class="savings-logo">ðŸ’°</div>
            <div class="savings-title">Totaal Sparen</div>
          </div>
          <div class="savings-amount" id="total-savings">â‚¬ 0,00</div>
          <div class="savings-last-updated">Automatisch berekend</div>
        </div>
      </div>

      <!-- Subcards (Horizontal) -->
      <div class="savings-subcards">
        <!-- Martine Pensioen - DeGiro -->
        <div class="savings-card">
          <div class="savings-card-header">
            <div class="savings-logo" style="background: #ff6200;">
              <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z'/%3E%3C/svg%3E" alt="DeGiro" style="width: 20px; height: 20px;" />
            </div>
            <div class="savings-title">Martine Pensioen</div>
          </div>
          <input type="text" class="savings-input" id="martine-pensioen" data-key="martine" placeholder="â‚¬ 0,00" />
          <div class="savings-last-updated" id="martine-updated">DeGiro</div>
        </div>

        <!-- Quincy Pensioen - Rabobank -->
        <div class="savings-card">
          <div class="savings-card-header">
            <div class="savings-logo" style="background: #002d5c;">
              <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z'/%3E%3C/svg%3E" alt="Rabobank" style="width: 20px; height: 20px;" />
            </div>
            <div class="savings-title">Quincy Pensioen</div>
          </div>
          <input type="text" class="savings-input" id="quincy-pensioen" data-key="quincy" placeholder="â‚¬ 0,00" />
          <div class="savings-last-updated" id="quincy-updated">Rabobank</div>
        </div>

        <!-- B.V. Belegging Sparen - ING Business -->
        <div class="savings-card">
          <div class="savings-card-header">
            <div class="savings-logo" style="background: #ff6200;">
              <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z'/%3E%3C/svg%3E" alt="ING" style="width: 20px; height: 20px;" />
            </div>
            <div class="savings-title">B.V. Belegging Sparen</div>
          </div>
          <input type="text" class="savings-input" id="bv-belegging" data-key="bv" placeholder="â‚¬ 0,00" />
          <div class="savings-last-updated" id="bv-updated">ING Business</div>
        </div>
      </div>
    </section>

    <h2 style="font-size: 1.3rem; margin-bottom: 16px;">Bankrekeningen</h2>
    <div id="cards" class="grid" role="list"></div>

    <section style="margin-top:18px;">
      <details>
        <summary><strong>Datasets beheren</strong> â€“ kies een bestand of upload een nieuwe</summary>
        <div style="margin-top:10px; display:flex; gap:10px; align-items:center;">
          <label for="global-dataset">Beschikbare datasets:</label>
          <select id="global-dataset"></select>
          <button id="refresh-datasets" class="btn ghost" type="button">Ververs</button>
          <input id="upload-input" type="file" accept=".csv,.tsv,.tab,.txt,.json" />
          <button id="upload-btn" class="btn" type="button">Upload</button>
          <span id="upload-msg" class="muted"></span>
        </div>
      </details>
    </section>

    <footer>
      <span>Last updated: <span id="ts"></span></span>
    </footer>
  </div>

  <script>
    document.getElementById('ts').textContent = new Date().toLocaleString('nl-NL');

    let DATASETS = [];

    // Savings management
    const SAVINGS_KEY = 'financial_dashboard_savings';
    
    function parseCurrency(str) {
      if (!str) return 0;
      // Remove â‚¬ symbol and spaces, then remove thousands separator (.), then convert decimal comma to period
      const cleaned = str.replace(/[â‚¬\s]/g, '').replace(/\./g, '').replace(',', '.');
      const num = parseFloat(cleaned);
      return isNaN(num) ? 0 : num;
    }
    
    function formatCurrency(num) {
      return 'â‚¬ ' + num.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    }
    
    function loadSavings() {
      try {
        const stored = localStorage.getItem(SAVINGS_KEY);
        return stored ? JSON.parse(stored) : {};
      } catch {
        return {};
      }
    }
    
    function saveSavings(data) {
      localStorage.setItem(SAVINGS_KEY, JSON.stringify(data));
    }
    
    function updateTotal() {
      const martine = parseCurrency(document.getElementById('martine-pensioen').value);
      const quincy = parseCurrency(document.getElementById('quincy-pensioen').value);
      const bv = parseCurrency(document.getElementById('bv-belegging').value);
      const total = martine + quincy + bv;
      document.getElementById('total-savings').textContent = formatCurrency(total);
    }
    
    function initSavings() {
      const data = loadSavings();
      
      // Load saved values
      if (data.martine !== undefined) document.getElementById('martine-pensioen').value = formatCurrency(data.martine);
      if (data.quincy !== undefined) document.getElementById('quincy-pensioen').value = formatCurrency(data.quincy);
      if (data.bv !== undefined) document.getElementById('bv-belegging').value = formatCurrency(data.bv);
      
      // Update last modified dates
      if (data.martine_updated) document.getElementById('martine-updated').textContent = 'DeGiro â€¢ ' + new Date(data.martine_updated).toLocaleDateString('nl-NL');
      if (data.quincy_updated) document.getElementById('quincy-updated').textContent = 'Rabobank â€¢ ' + new Date(data.quincy_updated).toLocaleDateString('nl-NL');
      if (data.bv_updated) document.getElementById('bv-updated').textContent = 'ING Business â€¢ ' + new Date(data.bv_updated).toLocaleDateString('nl-NL');
      
      updateTotal();
      
      // Add event listeners for real-time updates
      const inputs = ['martine-pensioen', 'quincy-pensioen', 'bv-belegging'];
      inputs.forEach(id => {
        const input = document.getElementById(id);
        input.addEventListener('input', () => {
          updateTotal();
        });
        
        input.addEventListener('blur', () => {
          const key = input.getAttribute('data-key');
          const value = parseCurrency(input.value);
          
          // Format the input
          input.value = formatCurrency(value);
          
          // Save to localStorage
          const data = loadSavings();
          data[key] = value;
          data[key + '_updated'] = new Date().toISOString();
          saveSavings(data);
          
          // Update last modified date
          const updateEl = document.getElementById(id.replace('-pensioen', '-updated').replace('-belegging', '-updated'));
          const bankName = key === 'martine' ? 'DeGiro' : key === 'quincy' ? 'Rabobank' : 'ING Business';
          updateEl.textContent = bankName + ' â€¢ ' + new Date().toLocaleDateString('nl-NL');
          
          updateTotal();
        });
      });
    }

    async function fetchDatasets(){
      try{
  // Optional account-specific list: if a ?account=<ID> query is present, pass it through
  const r = await fetch('/data/list', { cache:'no-store' });
        if(!r.ok) throw new Error('HTTP '+r.status);
        const j = await r.json();
        DATASETS = j.files || [];
        const sel = document.getElementById('global-dataset');
        sel.innerHTML = '<option value="">(kies bestand)</option>' + DATASETS.map(f => `<option value="${f.path}">${f.name}</option>`).join('');
      }catch(e){
        DATASETS = [];
        document.getElementById('global-dataset').innerHTML = '<option value="">(geen gegevens)</option>';
      }
    }

    async function loadAccounts(){
      try{
        const res = await fetch('/config/accounts.json', { cache:'no-store' });
        if(!res.ok) throw new Error('HTTP '+res.status);
        const cfg = await res.json();
        const list = Array.isArray(cfg.accounts) ? cfg.accounts : [];
        const el = document.getElementById('cards');
        el.innerHTML = list.map(acc => {
          const q = new URLSearchParams();
          q.set('accounts', acc.id);
          if (acc.defaultData) q.set('data', acc.defaultData);
          // Use bank-specific dashboard if available, otherwise unified
          const dashboardUrl = acc.dashboardPath || '/reports/unified_dashboard.html';
          const href = dashboardUrl + (dashboardUrl.includes('?') ? '&' : '?') + q.toString();
          const accept = (Array.isArray(acc.allowedExt) && acc.allowedExt.length)
            ? acc.allowedExt.join(',')
            : '.csv,.tsv,.tab,.txt,.json';
          return `
            <article class="card" role="listitem" aria-label="${acc.label}">
              <div class="title">${acc.label}</div>
              <div class="badge" title="Valuta">ðŸ’¶ ${acc.currency || 'EUR'}</div>
              <label class="muted" style="font-size:.85rem;">Dataset
                <select data-acc="${acc.id}" class="dataset-select" style="margin-left:6px;">
                  ${acc.defaultData ? `<option value="${acc.defaultData}">(standaard) ${acc.defaultData.split('/').pop()}</option>` : ''}
                </select>
              </label>
              <div class="actions">
                <a class="btn" href="${dashboardUrl}">Open dashboard</a>
                <a class="btn ghost" href="${href}&savings=on" title="Open met spaardoelen">Open (savings)</a>
                <button class="btn ghost open-selected" data-acc="${acc.id}" data-dashboard="${dashboardUrl}" type="button">Open met gekozen bestand</button>
                <label class="btn ghost" style="cursor:pointer;">
                  <input type="file" data-upload-for="${acc.id}" accept="${accept}" style="display:none;" />
                  Upload voor ${acc.id}
                </label>
              </div>
            </article>`;
        }).join('') || '<div class="muted">Geen accounts geconfigureerd.</div>';

        // populate per-card selects with global and account-specific datasets
        async function populateForAccount(acc){
          const sel = document.querySelector(`select.dataset-select[data-acc="${acc.id}"]`);
          if (!sel) return;
          const current = sel.value;
          // clear any previous optgroups (keep default/top option)
          [...sel.querySelectorAll('optgroup')].forEach(g => g.remove());
          // global
          const globalGroup = document.createElement('optgroup');
          globalGroup.label = 'Globaal';
          globalGroup.innerHTML = DATASETS.map(f => `<option value="${f.path}">${f.name}</option>`).join('');
          sel.appendChild(globalGroup);
          // account-specific uploads
          try{
            const r = await fetch('/data/list?account=' + encodeURIComponent(acc.id), { cache:'no-store' });
            if (r.ok){
              const j = await r.json();
              const accGroup = document.createElement('optgroup');
              accGroup.label = acc.id + ' uploads';
              accGroup.innerHTML = (j.files||[]).map(f => `<option value="${f.path}">${f.name}</option>`).join('');
              sel.appendChild(accGroup);
            }
          }catch{}
          if (current) sel.value = current;
        }
        await Promise.all(list.map(populateForAccount));
        // wire open-selected buttons
        document.querySelectorAll('.open-selected').forEach(btn => {
          btn.addEventListener('click', () => {
            const accId = btn.getAttribute('data-acc');
            const dashboardUrl = btn.getAttribute('data-dashboard') || '/reports/unified_dashboard.html';
            const sel = document.querySelector(`select.dataset-select[data-acc="${accId}"]`);
            const val = sel && sel.value;
            if(!val){ alert('Kies eerst een dataset.'); return; }
            const q = new URLSearchParams({ accounts: accId, data: val });
            window.location.href = dashboardUrl + '?' + q.toString();
          });
        });

        // per-account upload wiring
        document.querySelectorAll('input[type=file][data-upload-for]').forEach(inp => {
          inp.addEventListener('change', async () => {
            const accId = inp.getAttribute('data-upload-for');
            const file = inp.files && inp.files[0];
            if(!file) return;
            const fd = new FormData();
            fd.append('file', file);
            try{
              const r = await fetch('/upload?account=' + encodeURIComponent(accId), { method:'POST', body: fd });
              const j = await r.json();
              if(!j.ok) throw new Error(j.error || 'Upload mislukt');
              // refresh datasets and per-card list for this account
              await fetchDatasets();
              const sel = document.querySelector(`select.dataset-select[data-acc="${accId}"]`);
              if (sel){
                // rebuild optgroups so the new upload appears under the account group
                [...sel.querySelectorAll('optgroup')].forEach(g => g.remove());
                const globalGroup = document.createElement('optgroup');
                globalGroup.label = 'Globaal';
                globalGroup.innerHTML = DATASETS.map(f => `<option value="${f.path}">${f.name}</option>`).join('');
                sel.appendChild(globalGroup);
                try{
                  const r2 = await fetch('/data/list?account=' + encodeURIComponent(accId), { cache:'no-store' });
                  if (r2.ok){
                    const j2 = await r2.json();
                    const accGroup = document.createElement('optgroup');
                    accGroup.label = accId + ' uploads';
                    accGroup.innerHTML = (j2.files||[]).map(f => `<option value="${f.path}">${f.name}</option>`).join('');
                    sel.appendChild(accGroup);
                    // select the newest item (last in list)
                    if (j2.files && j2.files.length) sel.value = j2.files[j2.files.length-1].path;
                  }
                }catch{}
              }
              alert('GeÃ¼pload voor ' + accId + ': ' + j.path.split('/').pop());
            }catch(e){ alert(e.message); }
            inp.value = '';
          });
        });
      } catch(e){
        document.getElementById('cards').innerHTML = '<div class="muted">Kon accounts niet laden</div>';
      }
    }

    // Upload handler
    async function doUpload(){
      const inp = document.getElementById('upload-input');
      const msg = document.getElementById('upload-msg');
      const f = inp.files && inp.files[0];
      if(!f){ msg.textContent = 'Geen bestand gekozen'; return; }
      const fd = new FormData();
      fd.append('file', f);
      msg.textContent = 'Uploaden...';
      try{
        const r = await fetch('/upload', { method: 'POST', body: fd });
        const j = await r.json();
        if(!j.ok) throw new Error(j.error || 'Upload mislukt');
        msg.textContent = 'GeÃ¼pload: ' + (j.path.split('/').pop());
        await fetchDatasets();
      }catch(e){ msg.textContent = e.message; }
    }

    document.getElementById('refresh-datasets').addEventListener('click', fetchDatasets);
    document.getElementById('upload-btn').addEventListener('click', doUpload);

    // initial load
    initSavings();
    fetchDatasets().then(loadAccounts);
  </script>
</body>
</html>
