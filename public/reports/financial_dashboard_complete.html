<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financieel Analyse Dashboard - Familie Hernandez Ortiz</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .content {
            padding: 30px;
        }

        /* Alert Section */
        .alerts {
            margin-bottom: 30px;
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            font-weight: 500;
        }
        
        .alert.warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            color: #856404;
        }
        
        .alert.success {
            background: #d4edda;
            border-left: 4px solid #28a745;
            color: #155724;
        }
        
        .alert-icon {
            font-size: 1.5em;
            margin-right: 15px;
        }
        
        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border-left: 5px solid;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }
        
        .card.private {
            border-left-color: #e74c3c;
        }
        
        .card.business {
            border-left-color: #3498db;
        }
        
        .card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .balance {
            font-size: 2.2em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .balance.positive {
            color: #27ae60;
        }
        
        .balance.negative {
            color: #e74c3c;
        }
        
        .balance.neutral {
            color: #3498db;
        }
        
        /* Navigation Tabs */
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 30px;
            overflow-x: auto;
        }
        
        .tab {
            flex: 1;
            padding: 15px 20px;
            border: none;
            background: transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            white-space: nowrap;
            min-width: 150px;
        }
        
        .tab:hover {
            background: rgba(52, 152, 219, 0.1);
        }
        
        .tab.active {
            background: #3498db;
            color: white;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        
        /* Content Sections */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Tables */
        .table-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 25px;
            overflow: hidden;
        }
        
        .table-header {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 20px;
            font-size: 1.2em;
            font-weight: 600;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }
        
        tr:hover {
            background: #f8f9fa;
            transition: all 0.3s ease;
        }
        
        /* Amount styling */
        .amount {
            font-weight: bold;
            text-align: right;
        }
        
        .amount.positive {
            color: #27ae60;
        }
        
        .amount.negative {
            color: #e74c3c;
        }
        
        /* Category tags */
        .category-tag {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .cat-inkomsten { background: #27ae60; }
        .cat-zakelijk { background: #3498db; }
        .cat-vaste-lasten { background: #e74c3c; }
        .cat-boodschappen { background: #f39c12; }
        .cat-vervoer { background: #9b59b6; }
        .cat-sparen { background: #16a085; }
        .cat-belastingen { background: #7f8c8d; }
        .cat-lifestyle { background: #e67e22; }
        
        /* Insights Section */
        .insights {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
        }
        
        .insights h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.4em;
        }
        
        .insight-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #3498db;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .insight-item h4 {
            color: #2c3e50;
            margin-bottom: 8px;
        }
        
        .insight-item p {
            color: #5a6c7d;
            line-height: 1.5;
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .summary-cards {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                min-width: auto;
            }
            
            table {
                font-size: 0.9em;
            }
            
            th, td {
                padding: 10px 8px;
            }
        }

        /* Export buttons */
        .export-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .export-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .export-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        /* Category management */
        .category-management {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        }
        
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .category-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí∞ Financieel Analyse Dashboard <span class="pill" style="background:#2ecc71; color:#fff; padding:4px 8px; border-radius: 999px; font-size: .6em; vertical-align: middle;" id="dataStatus">loading‚Ä¶</span></h1>
            <p>Familie Hernandez Ortiz | Periode: <span id="periodLabel">-</span></p>
            <p style="font-size: 0.9em; opacity: 0.8;">Laatst bijgewerkt: <span id="lastUpdated">-</span></p>
        </div>
        
        <div class="content">
            <!-- Alert Section (dynamic) -->
            <div class="alerts" id="alerts"></div>

            <!-- Summary Cards -->
            <div class="summary-cards" id="cardsContainer"></div>

            <!-- Export Options -->
            <div class="export-buttons">
                <span class="muted" style="align-self:center">Bron:</span>
                <span id="sourcePath" class="kbd" style="background:#f0f3f8; border:1px solid #e2e8f0; padding:6px 8px; border-radius:6px;">/data/latest.tab</span>
                <button class="export-btn" id="reloadBtn" style="background:#fff; color:#1f2937; border:1px solid #e5e7eb;">Reload</button>
                <input id="customUrl" type="text" size="40" placeholder="/data/your-file.tab of volledige URL" style="border:1px solid #e5e7eb; border-radius:8px; padding:8px 10px;" />
                <button class="export-btn" id="loadBtn">Load URL</button>
                <span class="muted" style="align-self:center">Maand:</span>
                <select id="monthSelect" style="border:1px solid #e5e7eb; border-radius:8px; padding:8px 10px;"></select>
                <span class="muted" style="align-self:center">Rekeningen:</span>
                <div id="accountChips" class="toolbar" style="gap:6px"></div>
                <button class="export-btn" id="exportTxBtn">üìä Exporteer Transacties (CSV)</button>
                <button class="export-btn" id="exportCatBtn">üìÇ Exporteer Categorie√´n (CSV)</button>
                <button class="export-btn" onclick="showAirtableStructure()">üìã Airtable Structuur</button>
                <button class="export-btn" onclick="generateReport()">üìÑ Genereer Rapport</button>
            </div>

            <!-- Navigation Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="showTab('overview')">üìä Maandoverzicht</button>
                <button class="tab" onclick="showTab('accounts')">üè¶ Per Rekening</button>
                <button class="tab" onclick="showTab('categories')">üìÇ Categorie√´n</button>
                <button class="tab" onclick="showTab('insights')">üí° Inzichten</button>
                <button class="tab" onclick="showTab('settings')">‚öôÔ∏è Instellingen</button>
            </div>

            <!-- Overview Tab -->
            <div id="overview" class="tab-content active">
                <div class="table-container">
                    <div class="table-header" id="overviewTitle">üìä Maandelijkse Samenvatting</div>
                    <table>
                        <thead>
                            <tr>
                                <th>Rekening</th>
                                <th>Inkomsten</th>
                                <th>Uitgaven</th>
                                <th>Netto Resultaat</th>
                                <th>Status</th>
                                <th>Trend</th>
                            </tr>
                        </thead>
                        <tbody id="overviewBody"></tbody>
                    </table>
                </div>

                <div class="table-container">
                    <div class="table-header" id="historyTitle">üìà Historische Vergelijking</div>
                    <table>
                        <thead>
                            <tr>
                                <th>Maand</th>
                                <th>Totale Inkomsten</th>
                                <th>Totale Uitgaven</th>
                                <th>Netto Resultaat</th>
                                <th>Grootste Uitgave</th>
                            </tr>
                        </thead>
                        <tbody id="historyBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Accounts Tab -->
            <div id="accounts" class="tab-content">
                <div id="accountsTables"></div>
            </div>

            <!-- Categories Tab -->
            <div id="categories" class="tab-content">
                <div class="category-management">
                    <h3>üìÇ Verbeterde Categoriestructuur</h3>
                    <p style="margin-bottom: 20px; color: #5a6c7d;">
                        Geoptimaliseerd voor Nederlandse huishoudboekhouding volgens standaard financi√´le categorie√´n.
                    </p>
                    
                    <div class="category-grid">
                        <div class="category-item" style="border-left-color: #27ae60;">
                            <h4>üí∞ Inkomsten</h4>
                            <p><strong>Subcategorie√´n:</strong> Salaris, Freelance, Uitkeringen, Rente, Overig</p>
                            <p><strong>Juli totaal:</strong> ‚Ç¨2.815,00</p>
                        </div>
                        
                        <div class="category-item" style="border-left-color: #3498db;">
                            <h4>üíº Zakelijke Inkomsten</h4>
                            <p><strong>Subcategorie√´n:</strong> Factuuromzet, Projectinkomsten, Terugbetalingen</p>
                            <p><strong>Juli totaal:</strong> ‚Ç¨21.062,00</p>
                        </div>
                        
                        <div class="category-item" style="border-left-color: #e74c3c;">
                            <h4>üè† Vaste Lasten</h4>
                            <p><strong>Subcategorie√´n:</strong> Hypotheek/Huur, Verzekeringen, Energie, Water, Telecom</p>
                            <p><strong>Juli totaal:</strong> -‚Ç¨300,62</p>
                        </div>
                        
                        <div class="category-item" style="border-left-color: #f39c12;">
                            <h4>üõí Boodschappen</h4>
                            <p><strong>Subcategorie√´n:</strong> Supermarkt, Speciaalzaken, Online, Restaurants</p>
                            <p><strong>Juli totaal:</strong> -‚Ç¨127,50</p>
                        </div>
                        
                        <div class="category-item" style="border-left-color: #9b59b6;">
                            <h4>üöó Vervoer</h4>
                            <p><strong>Subcategorie√´n:</strong> Brandstof, OV, Onderhoud, Verzekering, Parkeren</p>
                            <p><strong>Juli totaal:</strong> -‚Ç¨7,20</p>
                        </div>
                        
                        <div class="category-item" style="border-left-color: #16a085;">
                            <h4>üìà Sparen & Beleggen</h4>
                            <p><strong>Subcategorie√´n:</strong> Spaarrekening, Beleggingen, Pensioen, Crypto</p>
                            <p><strong>Juli totaal:</strong> -‚Ç¨2.750,00</p>
                        </div>
                        
                        <div class="category-item" style="border-left-color: #7f8c8d;">
                            <h4>üèõÔ∏è Belastingen</h4>
                            <p><strong>Subcategorie√´n:</strong> Inkomstenbelasting, BTW, Gemeentebelasting</p>
                            <p><strong>Juli totaal:</strong> ‚Ç¨0,00</p>
                        </div>
                        
                        <div class="category-item" style="border-left-color: #e67e22;">
                            <h4>üéØ Lifestyle</h4>
                            <p><strong>Subcategorie√´n:</strong> Kleding, Entertainment, Sport, Hobby, Cadeaus</p>
                            <p><strong>Juli totaal:</strong> -‚Ç¨0,00</p>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <div class="table-header" id="catTitleDyn">üìä Uitgaven per Categorie</div>
                    <table>
                        <thead>
                            <tr>
                                <th>Categorie</th>
                                <th>Aantal Transacties</th>
                                <th>Totaal Bedrag</th>
                                <th>Gemiddeld per Transactie</th>
                                <th>% van Totale Uitgaven</th>
                            </tr>
                        </thead>
                        <tbody id="catBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Insights Tab -->
            <div id="insights" class="tab-content">
                <div class="insights">
                    <h3>üí° Financi√´le Inzichten & Aanbevelingen (dynamisch)</h3>
                    <div id="insightList"></div>
                </div>

                <div class="table-container">
                    <div class="table-header">üéØ Concrete Actieplan</div>
                    <table>
                        <thead>
                            <tr>
                                <th>Prioriteit</th>
                                <th>Actie</th>
                                <th>Bedrag</th>
                                <th>Deadline</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="5" style="color:#5a6c7d">Wordt dynamisch gevuld op basis van inzichten (beta)</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings" class="tab-content">
                <div class="category-management">
                    <h3>‚öôÔ∏è Dashboard Instellingen</h3>
                    
                    <div style="margin-bottom: 30px;">
                        <h4>üìã Airtable Configuratie</h4>
                        <p style="margin-bottom: 15px;">Structuur voor automatische analyse-herhaling:</p>
                        
                        <div class="table-container">
                            <div class="table-header">Airtable Tabellen Structuur</div>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Tabel</th>
                                        <th>Primaire Velden</th>
                                        <th>Doel</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>Transactions</strong></td>
                                        <td>Date, Description, Amount, Category, Account</td>
                                        <td>Alle transactiedata centraal opslaan</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Categories</strong></td>
                                        <td>Category Name, Color, Icon, Budget Limit</td>
                                        <td>Categorie-instellingen beheren</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Monthly Summary</strong></td>
                                        <td>Month, Account, Total Income, Total Expenses</td>
                                        <td>Maandelijkse samenvattingen automatiseren</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Insights</strong></td>
                                        <td>Date, Insight Type, Description, Action Required</td>
                                        <td>Financi√´le inzichten tracken</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <h4>üîÑ Automatisering Opties</h4>
                        <div class="insight-item">
                            <h4>Bank API Integratie</h4>
                            <p>Overweeg PSD2 Open Banking voor automatische transactie-import via ING en ABN AMRO API's.</p>
                        </div>
                        
                        <div class="insight-item">
                            <h4>Categorisatie Rules</h4>
                            <p>Implementeer regelgebaseerde categorisatie op basis van beschrijvingstekst en bedragen.</p>
                        </div>
                        
                        <div class="insight-item">
                            <h4>Alert Systeem</h4>
                            <p>Stel waarschuwingen in voor lage saldi, ongewone uitgaven en belastingdeadlines.</p>
                        </div>
                    </div>
                    
                    <div>
                        <h4>üìÅ Export Formaten</h4>
                        <p>Beschikbare export opties voor verdere analyse:</p>
                        <ul style="margin-left: 20px; margin-top: 10px;">
                            <li>CSV voor Excel/Google Sheets</li>
                            <li>JSON voor data-analyse tools</li>
                            <li>PDF rapport voor archivering</li>
                            <li>Airtable-ready format</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

        <script>
                // --- Utilities and data parsing (adapted from dynamic dashboard) ---
                const euro = new Intl.NumberFormat('nl-NL', { style: 'currency', currency: 'EUR' });
                const qs = new URLSearchParams(location.search);
                const defaultUrl = '/data/latest.tab';
                const dataUrl = qs.get('data') || defaultUrl;
                const el = (id) => document.getElementById(id);
                let lastData = { headers: [], allRows: [], sum: null };

                function detectDelimiter(text) {
                    const firstLine = text.split(/\r?\n/)[0] || '';
                    if (firstLine.includes('\t')) return '\t';
                    if (firstLine.includes(';')) return ';';
                    return ',';
                }

                function parseTable(text) {
                    const delim = detectDelimiter(text);
                    const lines = text.split(/\r?\n/).filter(Boolean);
                    if (!lines.length) return { headers: [], rows: [] };
                    const headers = lines[0].split(delim).map(h => h.trim());
                    let rows = lines.slice(1).map(l => l.split(delim).map(v => v.trim()));
                    const headerLooksLikeData = headers.every(h => /^(\d{8}|[\d\s.,-]+|[A-Za-z0-9\-]{3,})$/.test(h));
                    if (headerLooksLikeData) { rows = [headers, ...rows]; return { headers: [], rows }; }
                    return { headers, rows };
                }

                function mapColumns(headers) {
                    const idx = (names) => headers.findIndex(h => names.some(n => h.toLowerCase() === n || h.toLowerCase().includes(n)));
                    return { date: idx(['date','datum']), account: idx(['account','rekening']), description: idx(['description','omschrijving','beschrijving','description/omschrijving']), category: idx(['category','categorie']), amount: idx(['amount','bedrag','value']) };
                }

                function inferColumns(headers, rows) {
                    const colCount = headers.length || (rows[0] ? rows[0].length : 0);
                    const looksDate = (s) => /^\d{8}$/.test((s||'').replace(/\D/g,''));
                    const looksAmount = (s) => { if (!s) return false; return /[\-+]?\d+[\.,]\d{2}$/.test(s.replace(/\s/g,'')); };
                    const N = Math.min(rows.length, 100);
                    const scores = Array.from({length: colCount}, () => ({ amount:0, date:0, text:0, numeric:0 }));
                    for (let r=0; r<N; r++) { const row = rows[r] || []; for (let c=0; c<colCount; c++) { const v = row[c] || ''; if (looksAmount(v)) scores[c].amount++; if (looksDate(v)) scores[c].date++; if (/^[\d\s.,-]+$/.test(v)) scores[c].numeric++; else scores[c].text++; } }
                    let amount = 0; let amountScore = -1; for (let c=0; c<colCount; c++) { if (scores[c].amount > amountScore && scores[c].date === 0) { amountScore = scores[c].amount; amount = c; } }
                    let date = -1; let dateScore = -1; for (let c=0; c<colCount; c++) { if (scores[c].date > dateScore) { dateScore = scores[c].date; date = c; } }
                    let account = -1; for (let c=0; c<colCount; c++) { if (c !== date && c !== amount) { account = c; break; } }
                    const description = Math.max(0, colCount - 1);
                    return { date, account, description, category: -1, amount };
                }

                function toNumber(s) {
                    if (typeof s !== 'string') return Number(s) || 0;
                    const cleaned = s.replace(/\s/g, '').replace(/‚Ç¨/g,'').replace(/\./g,'').replace(/,/g,'.');
                    const n = Number(cleaned); return Number.isFinite(n) ? n : 0;
                }

                function monthKey(v) {
                    const s = (v||'').toString();
                    if (/^\d{8}$/.test(s)) return `${s.slice(0,4)}-${s.slice(4,6)}`;
                    const d = new Date(s); if (!isNaN(d)) return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
                    return 'unknown';
                }

                        function summarize(headers, rows) {
                    let cols = mapColumns(headers);
                    const noColsResolved = [cols.date, cols.account, cols.description, cols.category, cols.amount].every(v => v === -1);
                    if (noColsResolved || cols.amount === -1) cols = inferColumns(headers, rows);
                    // Month dropdown population and selection
                    const monthCounts = new Map();
                    rows.forEach(r => { const mk = cols.date >= 0 ? monthKey(r[cols.date]) : 'unknown'; monthCounts.set(mk, (monthCounts.get(mk)||0)+1); });
                            const months = Array.from(monthCounts.keys()).filter(m => m !== 'unknown').sort();
                            let selected = el('monthSelect').value || months[months.length-1] || 'all';
                            if (!el('monthSelect').value) {
                                if (months.length === 0) {
                                    el('monthSelect').innerHTML = '<option value="all">All</option>';
                                    el('monthSelect').value = 'all';
                                    selected = 'all';
                                } else {
                                    el('monthSelect').innerHTML = months.map(m => `<option value="${m}">${m}</option>`).join('');
                                    el('monthSelect').value = selected;
                                }
                            }
                    // Accounts list and active selection
                    const accounts = cols.account >= 0 ? Array.from(new Set(rows.map(r => r[cols.account]).filter(Boolean))) : [];
                    if (accounts.length) renderAccountChips(accounts);
                    const activeAccounts = getActiveAccounts(accounts);
                    // Filter rows by month and accounts
                    const filtered = rows.filter(r => {
                                const okMonth = (selected === 'all' || selected === 'unknown' || cols.date < 0) ? true : (monthKey(r[cols.date]) === selected);
                        const okAccount = (!accounts.length || activeAccounts.has(r[cols.account]));
                        return okMonth && okAccount;
                    });
                    // Totals
                    let income = 0, expenses = 0; const catAgg = new Map();
                    filtered.forEach(r => { const amt = toNumber(cols.amount >= 0 ? r[cols.amount] : 0); if (amt >= 0) income += amt; else expenses += amt; const cat = (cols.category >= 0 ? r[cols.category] : 'Uncategorized') || 'Uncategorized'; const v = catAgg.get(cat)||{count:0,sum:0}; v.count++; v.sum += amt; catAgg.set(cat, v); });
                    return { income, expenses, net: income + expenses, catAgg, cols, filtered, accounts, months, selected };
                }

                // ----- Account chips -----
                function renderAccountChips(accounts) {
                    const wrap = el('accountChips'); if (!wrap) return;
                    if (!renderAccountChips._state) { renderAccountChips._state = new Set(accounts); } else { accounts.forEach(a => renderAccountChips._state.add(a)); }
                    wrap.innerHTML = '';
                    accounts.forEach(acc => { const btn = document.createElement('button'); btn.className = renderAccountChips._state.has(acc) ? 'export-btn' : 'export-btn'; btn.style.background = renderAccountChips._state.has(acc) ? '#3498db' : '#fff'; btn.style.color = renderAccountChips._state.has(acc) ? '#fff' : '#1f2937'; btn.style.border = '1px solid #e5e7eb'; btn.style.borderRadius='999px'; btn.style.padding='6px 10px'; btn.textContent = acc; btn.addEventListener('click', () => { if (renderAccountChips._state.has(acc)) { renderAccountChips._state.delete(acc); btn.style.background='#fff'; btn.style.color='#1f2937'; } else { renderAccountChips._state.add(acc); btn.style.background='#3498db'; btn.style.color='#fff'; } load(el('sourcePath').textContent); }); wrap.appendChild(btn); });
                }
                function getActiveAccounts(all) { if (!renderAccountChips._state) return new Set(all); if (renderAccountChips._state.size === 0) return new Set(all); return new Set(Array.from(renderAccountChips._state)); }

                // ---- Rendering functions for this page ----
                function updateHeader(sum) {
                    el('periodLabel').textContent = sum.selected || '-';
                    el('lastUpdated').textContent = new Date().toLocaleString('nl-NL');
                    el('dataStatus').textContent = 'OK';
                }

                function renderAlerts(sum, perAccount) {
                    const wrap = el('alerts'); wrap.innerHTML = '';
                    const make = (cls, icon, strong, text) => {
                        const d = document.createElement('div'); d.className = `alert ${cls}`; d.innerHTML = `<span class="alert-icon">${icon}</span><div><strong>${strong}</strong> ${text}</div>`; wrap.appendChild(d);
                    };
                    if (sum.net < 0) make('warning','‚ö†Ô∏è','Aandacht vereist:','Netto resultaat is negatief deze maand. Controleer uitgaven.');
                    else make('success','‚úÖ','Positief:','Netto resultaat is positief deze maand.');
                    // Find most negative account
                    const worst = perAccount.slice().sort((a,b)=>a.net-b.net)[0];
                    if (worst && worst.net < 0) make('warning','‚ö†Ô∏è','Account in het rood:', `${worst.account} heeft een negatief netto van ${euro.format(worst.net)} in ${sum.selected}.`);
                }

                function renderSummaryCards(sum, perAccount) {
                    const cont = el('cardsContainer'); cont.innerHTML = '';
                    // Total card
                    const totalCard = document.createElement('div'); totalCard.className = 'card business';
                    totalCard.innerHTML = `<h3>üìä Totaal Overzicht</h3><div class="balance ${sum.net>=0?'positive':'negative'}">${euro.format(sum.net)}</div><p><strong>Inkomsten:</strong> ${euro.format(sum.income)}</p><p><strong>Uitgaven:</strong> ${euro.format(Math.abs(sum.expenses))}</p>`;
                    cont.appendChild(totalCard);
                    // Per-account cards
                    perAccount.forEach(a => {
                        const div = document.createElement('div'); div.className = 'card ' + (a.net>=0?'business':'private');
                        div.innerHTML = `<h3>${a.icon||'üè¶'} ${a.account}</h3><div class="balance ${a.net>=0?'positive':'negative'}">${euro.format(a.net)}</div><p><strong>Inkomsten:</strong> ${euro.format(a.income)}</p><p><strong>Uitgaven:</strong> ${euro.format(Math.abs(a.expenses))}</p>`;
                        cont.appendChild(div);
                    });
                }

                function renderOverview(sum, perAccount, prevMonthMap) {
                    el('overviewTitle').textContent = `üìä Maandelijkse Samenvatting - ${sum.selected || ''}`;
                    const tbody = el('overviewBody');
                    const rows = perAccount.map(a => {
                        const prev = prevMonthMap.get(a.account) || { net: 0 };
                        const trend = a.net >= prev.net ? 'üìà Stijgend' : 'üìâ Dalend';
                        const status = a.net >= 0 ? '‚úÖ Positief' : '‚ö†Ô∏è Tekort';
                        return `<tr><td><strong>${a.account}</strong></td><td class="amount positive">${euro.format(a.income)}</td><td class="amount negative">-${euro.format(Math.abs(a.expenses)).replace('‚Ç¨','')}</td><td class="amount ${a.net>=0?'positive':'negative'}">${a.net>=0?'+':''}${euro.format(a.net)}</td><td>${status}</td><td>${trend}</td></tr>`;
                    });
                    // total row
                    rows.push(`<tr style="background:#f8f9fa; font-weight:bold;"><td><strong>TOTAAL</strong></td><td class="amount positive">${euro.format(sum.income)}</td><td class="amount negative">-${euro.format(Math.abs(sum.expenses)).replace('‚Ç¨','')}</td><td class="amount ${sum.net>=0?'positive':'negative'}">${sum.net>=0?'+':''}${euro.format(sum.net)}</td><td>${sum.net>=0?'‚úÖ Positief':'‚ö†Ô∏è Negatief'}</td><td></td></tr>`);
                    tbody.innerHTML = rows.join('');
                }

                function renderHistory(headers, allRows, cols, months, selected) {
                    el('historyTitle').textContent = 'üìà Historische Vergelijking';
                    const monthSet = new Set(months);
                    const monthOrder = months.slice().sort();
                    const byMonth = new Map();
                    monthOrder.forEach(m => byMonth.set(m, { income:0, expenses:0, net:0, cats:new Map() }));
                    allRows.forEach(r => { const m = cols.date>=0 ? monthKey(r[cols.date]) : 'unknown'; if (!monthSet.has(m)) return; const amt = toNumber(cols.amount>=0? r[cols.amount] : 0); const bucket = byMonth.get(m); if (!bucket) return; if (amt>=0) bucket.income += amt; else bucket.expenses += amt; bucket.net = bucket.income + bucket.expenses; const cat = (cols.category>=0? r[cols.category] : 'Uncategorized') || 'Uncategorized'; const v = bucket.cats.get(cat)||0; bucket.cats.set(cat, v+amt); });
                    const tbody = el('historyBody');
                    const last6 = monthOrder.slice(-6);
                    const rows = last6.map(m => { const b = byMonth.get(m) || {income:0, expenses:0, net:0, cats:new Map()}; const biggest = Array.from(b.cats.entries()).sort((a,b)=>Math.abs(b[1]) - Math.abs(a[1]))[0]; const label = new Date(m+'-01'); const monthLabel = label.toLocaleDateString('nl-NL', { month:'long', year:'numeric' }); const biggestText = biggest ? `${biggest[0]} (${euro.format(biggest[1])})` : '-'; return `<tr><td><strong>${monthLabel}</strong></td><td class="amount positive">${euro.format(b.income)}</td><td class="amount negative">-${euro.format(Math.abs(b.expenses)).replace('‚Ç¨','')}</td><td class="amount ${b.net>=0?'positive':'negative'}">${b.net>=0?'+':''}${euro.format(b.net)}</td><td>${biggestText}</td></tr>`; }).join('');
                    tbody.innerHTML = rows || '<tr><td colspan="5">Geen historische data</td></tr>';
                }

                function renderAccountsTables(headers, filteredRows, cols, selected) {
                    const cont = el('accountsTables'); cont.innerHTML='';
                    const groups = new Map();
                    filteredRows.forEach(r => { const acc = cols.account>=0 ? (r[cols.account] || 'Onbekend') : 'Onbekend'; if (!groups.has(acc)) groups.set(acc, []); groups.get(acc).push(r); });
                    const accs = Array.from(groups.keys()).sort();
                    accs.forEach(acc => {
                        const rows = groups.get(acc) || [];
                        const div = document.createElement('div'); div.className='table-container';
                        const title = document.createElement('div'); title.className='table-header'; title.textContent = `${acc} - ${selected} Transacties`;
                        const table = document.createElement('table');
                        const thead = document.createElement('thead'); const trh = document.createElement('tr');
                        const colsToShow = [];
                        const displayHeaders = (function(){ const colCount = rows[0]?.length || headers.length || 0; let d = headers && headers.length ? headers.slice() : Array.from({length: colCount}, (_, i) => `C${i+1}`); if (cols.date>=0 && cols.date<d.length) d[cols.date]='Datum'; if (cols.description>=0 && cols.description<d.length) d[cols.description]='Beschrijving'; if (cols.category>=0 && cols.category<d.length) d[cols.category]='Categorie'; if (cols.amount>=0 && cols.amount<d.length) d[cols.amount]='Bedrag'; if (cols.account>=0 && cols.account<d.length) d[cols.account]='Rekening'; return d; })();
                        // Prefer key columns order
                        const order = [cols.date, cols.description, cols.category, cols.amount].filter(i => i>=0);
                        order.forEach(i => { colsToShow.push(i); const th = document.createElement('th'); th.textContent = displayHeaders[i] || `C${i+1}`; trh.appendChild(th); });
                        thead.appendChild(trh);
                        const tbody = document.createElement('tbody');
                        rows.forEach(r => {
                            const tr = document.createElement('tr');
                            colsToShow.forEach(i => {
                                const td = document.createElement('td');
                                let val = r[i] || '';
                                if (i === cols.amount) { td.className = 'amount ' + (toNumber(val)>=0 ? 'positive':'negative'); val = (toNumber(val)>=0 ? '' : '-') + euro.format(Math.abs(toNumber(val))).replace('‚Ç¨',''); td.innerHTML = (toNumber(r[i])>=0 ? euro.format(toNumber(r[i])) : '-' + euro.format(Math.abs(toNumber(r[i])))).replace('‚Ç¨','‚Ç¨'); }
                                td.textContent = i===cols.amount ? (toNumber(r[i])>=0 ? euro.format(toNumber(r[i])) : '-' + euro.format(Math.abs(toNumber(r[i])))) : val; tr.appendChild(td);
                            });
                            tbody.appendChild(tr);
                        });
                        table.appendChild(thead); table.appendChild(tbody);
                        div.appendChild(title); div.appendChild(table); cont.appendChild(div);
                    });
                }

                function renderCategories(sum) {
                    const tbody = el('catBody');
                    const entries = Array.from(sum.catAgg.entries());
                    if (!entries.length) {
                        el('catTitleDyn').textContent = `üìä Uitgaven per Categorie - ${sum.selected || ''}`;
                        tbody.innerHTML = '<tr><td colspan="5">Geen categorie-data</td></tr>';
                        return;
                    }
                    // Totaal negatieve uitgaven voor percentageberekening
                    const totalNeg = entries.reduce((a, [, v]) => a + (v.sum < 0 ? Math.abs(v.sum) : 0), 0);
                    const denom = totalNeg > 0 ? totalNeg : 1; // voorkom delen door 0

                    // Sorteer op absolute waarde (grootste eerst)
                    const rows = entries
                        .sort((a, b) => Math.abs(b[1].sum) - Math.abs(a[1].sum))
                        .map(([cat, v]) => {
                            const count = v.count || 0;
                            const avg = count > 0 ? Math.abs(v.sum) / count : 0;
                            const pct = v.sum < 0 ? (Math.abs(v.sum) / denom) * 100 : 0;
                            const catLabel = `<span class="category-tag">${cat}</span>`;
                            return `<tr>
                                <td>${catLabel}</td>
                                <td>${count}</td>
                                <td class="amount ${v.sum >= 0 ? 'positive' : 'negative'}">${euro.format(v.sum)}</td>
                                <td class="amount">${euro.format(avg)}</td>
                                <td>${pct.toFixed(1)}%</td>
                            </tr>`;
                        })
                        .join('');
                    el('catTitleDyn').textContent = `üìä Uitgaven per Categorie - ${sum.selected || ''}`;
                    tbody.innerHTML = rows;
                }

                function buildDisplayHeaders(headers, cols) {
                    const colCount = lastData.sum?.filtered?.[0]?.length || headers.length || 0;
                    let display = headers && headers.length ? headers.slice() : Array.from({length: colCount}, (_, i) => `C${i+1}`);
                    if (cols.date>=0 && cols.date<display.length) display[cols.date]='Date';
                    if (cols.account>=0 && cols.account<display.length) display[cols.account]='Account';
                    if (cols.description>=0 && cols.description<display.length) display[cols.description]='Description';
                    if (cols.category>=0 && cols.category<display.length) display[cols.category]='Category';
                    if (cols.amount>=0 && cols.amount<display.length) display[cols.amount]='Amount';
                    return display;
                }

                function toCSV(rows) { return rows.map(r => r.map(v => { const s = (v ?? '').toString(); if (/[",\n;\t]/.test(s)) return '"' + s.replace(/"/g, '""') + '"'; return s; }).join(',')).join('\n'); }
                function downloadCSV(csvText, filename) { const blob = new Blob([csvText], { type: 'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); }
                function exportTransactionsCSV() { if (!lastData.sum) return; const { headers, sum } = lastData; const cols = sum.cols; const rows = sum.filtered?.length ? sum.filtered : lastData.allRows; const headerRow = buildDisplayHeaders(headers, cols); const addMonth = cols && cols.date>=0; const out = []; out.push(addMonth ? [...headerRow, 'Month'] : headerRow); for (const r of rows) { const m = addMonth ? monthKey(r[cols.date]) : undefined; out.push(addMonth ? [...r, m] : r); } const csv = toCSV(out); const month = sum.selected || 'all'; downloadCSV(csv, `transactions_${month}.csv`); }
                function exportCategoriesCSV() { if (!lastData.sum) return; const entries = Array.from(lastData.sum.catAgg.entries()).sort((a,b)=>Math.abs(b[1].sum) - Math.abs(a[1].sum)); const out = [['Category','Count','Amount']]; for (const [cat,v] of entries) out.push([cat, String(v.count), v.sum.toFixed(2)]); const csv = toCSV(out); const month = lastData.sum.selected || 'all'; downloadCSV(csv, `categories_${month}.csv`); }

                function showAirtableStructure() {
                    alert(`Airtable Structuur voor Familie Hernandez Ortiz:\n\nüìä TRANSACTIONS TABLE\n- Date (Date field)\n- Description (Single line text)\n- Amount (Currency - EUR)\n- Category (Single select)\n- Subcategory (Single select)\n- Account (Single select)\n- Transaction Type (Single select)\n- Notes (Long text)\n\nüìÇ CATEGORIES TABLE\n- Category Name\n- Color\n- Icon\n- Budget Limit\n- Type (Income, Fixed, Variable, Investment)\n\nüìà MONTHLY SUMMARY TABLE\n- Month\n- Account\n- Total Income\n- Total Expenses\n- Net Amount\n- Status`);
                }

                function generateReport() {
                    if (!lastData.sum) { alert('Nog geen data geladen.'); return; }
                    const s = lastData.sum; const month = s.selected || ''; const txt = `üìÑ FINANCIEEL RAPPORT - ${month}\nFamilie Hernandez Ortiz\n\nSAMENVATTING:\n‚Ä¢ Totale inkomsten: ${euro.format(s.income)}\n‚Ä¢ Totale uitgaven: ${euro.format(Math.abs(s.expenses))}\n‚Ä¢ Netto resultaat: ${s.net>=0?'+':''}${euro.format(s.net)}\n\nBELANGRIJKSTE BEVINDINGEN:\n‚Ä¢ Grootste uitgavencategorie: ${Array.from(s.catAgg.entries()).sort((a,b)=>Math.abs(b[1].sum)-Math.abs(a[1].sum))[0]?.[0] || '-'}\n‚Ä¢ Aantal transacties: ${s.filtered.length}\n\nRapport gegenereerd op ${new Date().toLocaleDateString('nl-NL')}`; alert(txt);
                }

                function computePerAccount(sum) {
                    const accMap = new Map(); const cols = sum.cols;
                    sum.filtered.forEach(r => { const acc = cols.account>=0 ? (r[cols.account] || 'Onbekend') : 'Onbekend'; const amt = toNumber(cols.amount>=0? r[cols.amount] : 0); if (!accMap.has(acc)) accMap.set(acc, { account: acc, income:0, expenses:0, net:0 }); const a = accMap.get(acc); if (amt>=0) a.income += amt; else a.expenses += amt; a.net = a.income + a.expenses; });
                    return Array.from(accMap.values()).sort((a,b)=>a.account.localeCompare(b.account));
                }

                        function computePrevMonthPerAccount(allRows, cols, selected) {
                            if (cols.date === undefined || cols.date === null || cols.date < 0) return new Map();
                    const [y,m] = selected.split('-'); const d = new Date(Number(y), Number(m)-2, 1); // previous month
                    const prevKey = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
                    const map = new Map();
                    allRows.filter(r => monthKey(r[cols.date])===prevKey).forEach(r => { const acc = cols.account>=0 ? (r[cols.account] || 'Onbekend') : 'Onbekend'; const amt = toNumber(cols.amount>=0? r[cols.amount] : 0); const o = map.get(acc)||{income:0, expenses:0, net:0}; if (amt>=0) o.income += amt; else o.expenses += amt; o.net = o.income + o.expenses; map.set(acc,o); });
                    return map;
                }

                async function load(url) {
                    try {
                        el('dataStatus').textContent = 'loading‚Ä¶'; el('sourcePath').textContent = url;
                        const bust = (url.includes('?') ? '&' : '?') + '_ts=' + Date.now();
                        const res = await fetch(url + bust, { cache: 'no-store' }); if (!res.ok) throw new Error(`HTTP ${res.status}`);
                        const text = await res.text(); const { headers, rows } = parseTable(text); if (!rows.length) throw new Error('No rows');
                        const sum = summarize(headers, rows);
                        // store
                        lastData = { headers, allRows: rows, sum };
                        // Compute helpers
                        const perAccount = computePerAccount(sum);
                        const prevMonthMap = computePrevMonthPerAccount(rows, sum.cols, sum.selected);
                        // Update UI sections
                        updateHeader(sum);
                        renderAlerts(sum, perAccount);
                        renderSummaryCards(sum, perAccount);
                        renderOverview(sum, perAccount, prevMonthMap);
                        renderHistory(headers, rows, sum.cols, sum.months, sum.selected);
                        renderAccountsTables(headers, sum.filtered, sum.cols, sum.selected);
                        renderCategories(sum);
                    } catch (e) {
                        el('dataStatus').textContent = 'error';
                        alert('Kon data niet laden: ' + e.message);
                    }
                }

                // Tab functionality
                function showTab(tabName) {
                        const tabContents = document.querySelectorAll('.tab-content'); tabContents.forEach(content => content.classList.remove('active'));
                        const tabs = document.querySelectorAll('.tab'); tabs.forEach(tab => tab.classList.remove('active'));
                        document.getElementById(tabName).classList.add('active'); event.target.classList.add('active');
                }

                // Wire controls
                document.addEventListener('DOMContentLoaded', function() {
                    // initial load
                    load(dataUrl);
                    // controls
                    el('reloadBtn').addEventListener('click', () => load(el('sourcePath').textContent));
                    el('loadBtn').addEventListener('click', () => { const u = el('customUrl').value.trim(); if (u) load(u); });
                    el('monthSelect').addEventListener('change', () => load(el('sourcePath').textContent));
                    el('exportTxBtn').addEventListener('click', exportTransactionsCSV);
                    el('exportCatBtn').addEventListener('click', exportCategoriesCSV);
                });
        </script>
</body>
</html>