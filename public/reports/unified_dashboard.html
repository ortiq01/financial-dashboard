<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Unified Financial Dashboard</title>
  <style>
    :root {
      --bg: #f6f8fb;
      --card: #fff;
      --muted: #6b7280;
      --text: #111827;
      --primary: #2563eb;
      --green: #16a34a;
      --red: #dc2626;
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:var(--bg); color:var(--text); }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 24px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:16px; }
    h1 { margin:0; font-size: 1.5rem; }
    .pill { background:#e5f0ff; color:#1e40af; padding:4px 8px; border-radius:999px; font-size:.8rem; }
  .row { display:flex; flex-wrap:wrap; gap:16px; }
    .card { background:var(--card); border-radius:12px; box-shadow: 0 8px 20px rgba(0,0,0,.06); padding:16px; }
    .toolbar { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .kbd { background:#eef2f7; border:1px solid #e5e7eb; padding:6px 8px; border-radius:6px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .btn { background:var(--primary); color:#fff; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; }
    .btn.ghost { background:#fff; color:#111827; border:1px solid #e5e7eb; }
    .btn.chip { border-radius:999px; padding:6px 10px; }
    .muted { color:var(--muted); }
    .grid-3 { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:16px; }
    .kpi { display:flex; flex-direction:column; gap:6px; }
    .kpi .value { font-size:1.6rem; font-weight:700; }
    .value.pos { color:var(--green); }
    .value.neg { color:var(--red); }
    table { width:100%; border-collapse: collapse; }
    th, td { padding:10px 8px; border-bottom:1px solid #eee; text-align:left; }
    th { background:#f9fafb; font-weight:600; }
    tr:hover { background:#f8fafc; }
    .amount { font-weight:600; text-align:right; }
    .amount.pos { color:var(--green); }
    .amount.neg { color:var(--red); }
    .section-title { font-size:1.1rem; margin:0 0 8px; }
    .category-tag { display:inline-block; padding:4px 10px; border-radius:999px; font-size:.8rem; color:#fff; background:#64748b; }
    .insight { border-left:4px solid #2563eb; padding-left:12px; margin:10px 0; }
  .row-click { cursor:pointer; }
  .row-active { background:#eef2ff; }
  /* Filter pill */
  .filter-pill { display:inline-flex; align-items:center; gap:6px; background:#e5f0ff; color:#1e40af; padding:6px 10px; border-radius:999px; font-size:.85rem; }
  .filter-pill .clear { cursor:pointer; color:#1f2937; margin-left:6px; font-weight:700; }
  .menu { position: relative; display:inline-block; }
  .menu-dropdown { position:absolute; right:0; top:40px; background:#fff; border:1px solid #e5e7eb; border-radius:8px; min-width:200px; box-shadow:0 8px 20px rgba(0,0,0,.15); z-index:2000; }
  .menu-dropdown a { display:block; padding:8px 12px; color:#111827; text-decoration:none; }
  .menu-dropdown a:hover { background:#f3f4f6; }
  /* Modal */
  .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:1000; }
  .modal { background:#fff; width:min(560px, 92vw); border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.2); padding:16px; }
  .modal h3 { margin:0 0 12px; }
  .modal .row { display:flex; gap:12px; }
  .modal label { display:block; font-size:.9rem; color:#374151; margin-bottom:6px; }
  .modal input[type="text"], .modal select { width:100%; padding:8px 10px; border:1px solid #e5e7eb; border-radius:8px; background:#f9fafb; }
  .modal .actions { display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }
  .show { display:flex !important; }
    /* Mobile tweaks */
    @media (max-width: 720px){
      .row { flex-direction:column; }
      body { font-size: 15px; }
      .wrap { padding: 16px; }
      header { gap: 10px; }
      .toolbar { gap: 6px; }
      .card { padding: 12px; }
      table { font-size: 14px; }
      th, td { padding: 8px 6px; }
      /* Make URL input span full width on mobile */
      #customUrl { width: 100%; max-width: 100%; }
    }

    /* Sticky table headers for better context while scrolling */
    table thead th { position: sticky; top: 0; z-index: 1; }

    /* Narrow phone optimizations */
    @media (max-width: 380px){
      body { font-size: 14px; }
      table { font-size: 13px; }
      /* Relax card min-width so cards don't force horizontal scroll */
      .row .card[style*="min-width:380px"], .row .card[style*="min-width:280px"] { min-width: auto !important; }
      /* Hide low-priority columns to fit */
      /* Categories: hide Gemiddeld and % columns on very small screens */
      #catTable th:nth-child(4), #catTable td:nth-child(4),
      #catTable th:nth-child(5), #catTable td:nth-child(5){ display:none; }
      /* Monthly: show Maand, Uitgaven, Netto; hide Inkomsten and Delta */
      #monthTable th:nth-child(2), #monthTable td:nth-child(2),
      #monthTable th:nth-child(5), #monthTable td:nth-child(5){ display:none; }
      /* Transactions: show Date, Description, Amount; hide extras */
      #txTable th:nth-child(n+4), #txTable td:nth-child(n+4){ display:none; }
    }
  </style>
  <meta name="robots" content="noindex" />
  <meta name="color-scheme" content="light" />
  <link rel="icon" href="data:," />
  <meta name="description" content="Unified financial dashboard with totals, category breakdowns, and AI recommendations." />
  <meta name="referrer" content="no-referrer" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <script>/* prevent FOUC */</script>
  
  
  
  
  
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Unified Financial Dashboard <span id="dataStatus" class="pill">loading‚Ä¶</span></h1>
        <div class="muted">Periode: <span id="periodLabel">-</span> ‚Ä¢ Laatst bijgewerkt: <span id="lastUpdated">-</span></div>
      </div>
      <div class="toolbar">
        <span class="muted">Bron:</span>
        <span id="sourcePath" class="kbd">/data/latest.tab</span>
        <button id="reloadBtn" class="btn ghost">Reload</button>
  <button id="syncBtn" class="btn" title="Start GoCardless sync">üîÅ Sync</button>
        <div class="menu" style="margin-left:8px;">
          <button id="helpMenuBtn" class="btn ghost" title="Meer opties">‚ò∞</button>
          <div id="helpMenu" class="menu-dropdown" style="display:none">
            <a href="#" id="resetFiltersLink">Reset filters</a>
            <a href="#" id="openRulesLink">Open Beheer regels</a>
            <a href="/reports/index.html">Rapporten index</a>
            <a href="#" id="aboutLink">Over deze pagina</a>
          </div>
        </div>
      </div>
    </header>

    <div class="card" style="margin-bottom:16px;">
      <div class="toolbar">
  <input id="customUrl" type="text" size="40" placeholder="/data/your-file.tab of volledige URL" class="kbd" style="padding:8px 10px;" />
        <button id="loadBtn" class="btn">Load URL</button>
  <label class="btn ghost" for="fileInput" title="Laad lokaal CSV/TAB/TXT">üì• Upload</label>
  <input id="fileInput" type="file" accept=".csv,.tab,.txt,text/csv,text/tab-separated-values,text/plain" style="display:none" />
        <span class="muted">Maand:</span>
        <select id="monthSelect" class="kbd" style="padding:8px 10px;"></select>
        <span class="muted">Rekeningen:</span>
        <div id="accountChips" class="toolbar" style="gap:6px"></div>
  <label class="kbd" style="display:inline-flex; align-items:center; gap:6px; padding:6px 8px;"><input type="checkbox" id="excludeTransfers" /> Transfers uitsluiten</label>
  <label class="kbd" style="display:inline-flex; align-items:center; gap:6px; padding:6px 8px;"><input type="checkbox" id="aggressiveDedupe" /> Aggressieve dedupe</label>
        <button id="exportTxBtn" class="btn">üìä Export Transacties (CSV)</button>
        <button id="exportCatBtn" class="btn">üìÇ Export Categorie√´n (CSV)</button>
  <button id="rulesBtn" class="btn ghost">‚öôÔ∏è Beheer regels</button>
      </div>
    </div>

    <div class="row">
      <div class="card" style="flex:1; min-width:280px;">
        <h3 class="section-title">Kerncijfers</h3>
        <div class="grid-3">
          <div class="kpi"><div class="muted">Totale Inkomsten</div><div id="kpiIncome" class="value pos">-</div></div>
          <div class="kpi"><div class="muted">Totale Uitgaven</div><div id="kpiExpenses" class="value neg">-</div></div>
          <div class="kpi"><div class="muted">Netto Resultaat</div><div id="kpiNet" class="value">-</div></div>
        </div>
        <h3 class="section-title" style="margin-top:12px;">Per Rekening</h3>
        <div style="overflow:auto">
          <table id="catTable">
            <thead><tr><th>Rekening</th><th>In</th><th>Uit</th><th>Netto</th></tr></thead>
            <tbody id="acctBody"></tbody>
          </table>
        </div>
      </div>
      <div class="card" style="flex:1; min-width:280px;">
        <h3 class="section-title">AI Aanbevelingen</h3>
        <div id="insightList"></div>
      </div>
    </div>

    <div class="row">
      <div class="card" style="flex:2; min-width:380px;">
        <h3 id="catTitleDyn" class="section-title">Uitgaven per Categorie</h3>
        <div style="overflow:auto">
          <table>
            <thead><tr><th>Categorie</th><th>Aantal</th><th>Totaal</th><th>Gemiddeld</th><th>% van Uitgaven</th></tr></thead>
            <tbody id="catBody"></tbody>
            <tfoot><tr id="catTotalRow"></tr></tfoot>
          </table>
        </div>
      </div>
    </div>

    <div class="card">
    <h3 class="section-title">Maandelijkse Samenvatting</h3>
      <div style="overflow:auto">
  <table id="monthTable">
  <thead><tr><th>Maand</th><th>Inkomsten</th><th>Uitgaven</th><th>Netto</th><th>Œî Netto (vs vorige maand)</th></tr></thead>
          <tbody id="monthBody"></tbody>
        </table>
      </div>
    </div>

    <div class="card" id="transactionsSection">
    <h3 class="section-title">Recentste Transacties</h3>
      <div id="txFilterBar" class="toolbar" style="margin-bottom:8px;"></div>
      <div style="overflow:auto">
  <table id="txTable">
      <thead id="txHead"></thead>
          <tbody id="txBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Edit Category Modal -->
  <div id="editModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="editTitle">
    <div class="modal">
      <h3 id="editTitle">Categorie wijzigen</h3>
      <div class="row">
        <div style="flex:1">
          <label>Beschrijving</label>
          <div id="editDesc" class="kbd" style="white-space:pre-wrap"></div>
        </div>
      </div>
      <div class="row" style="margin-top:8px;">
        <div style="flex:1">
          <label>Hoofdcategorie</label>
          <select id="editMain"></select>
        </div>
        <div style="flex:1">
          <label>Subcategorie</label>
          <input id="editSub" type="text" placeholder="bijv. Boodschappen - Supermarkt" />
        </div>
      </div>
      <div style="margin-top:10px;">
        <label><input type="checkbox" id="editApplyKeyword" /> Regel toepassen op trefwoord</label>
        <input id="editKeyword" type="text" class="kbd" placeholder="trefwoord (bijv. 'ah ' of 'vodafone')" style="margin-left:8px; padding:6px 8px;" />
      </div>
      <div class="actions">
        <button id="editCancel" class="btn ghost">Annuleren</button>
        <button id="editSave" class="btn">Opslaan</button>
      </div>
    </div>
  </div>

  <!-- Rules Manager Modal -->
  <div id="rulesModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="rulesTitle">
    <div class="modal">
      <h3 id="rulesTitle">Regelbeheer</h3>
      <div class="muted" style="margin-bottom:8px;">Bekijk of verwijder handmatige categorie-overrides.</div>
      <div style="max-height:40vh; overflow:auto;">
        <h4 class="section-title">Trefwoordregels</h4>
        <table>
          <thead><tr><th>Keyword</th><th>Hoofdcategorie</th><th>Subcategorie</th><th>Actie</th></tr></thead>
          <tbody id="kwRulesBody"></tbody>
        </table>
        <h4 class="section-title" style="margin-top:12px;">Transactie-specifieke regels</h4>
        <table>
          <thead><tr><th>Sleutel</th><th>Hoofdcategorie</th><th>Subcategorie</th><th>Actie</th></tr></thead>
          <tbody id="keyRulesBody"></tbody>
        </table>
      </div>
      <div class="actions">
        <button id="rulesClear" class="btn ghost">Alles wissen</button>
        <button id="rulesClose" class="btn">Sluiten</button>
      </div>
    </div>
  </div>

  <script>
    // Utilities and parsing
    const euro = new Intl.NumberFormat('nl-NL', { style: 'currency', currency: 'EUR' });
    const qs = new URLSearchParams(location.search);
  const defaultUrl = '/data/latest.tab';
  const dataUrl = qs.get('data') || defaultUrl;
  const qsMonth = qs.get('month') || null;
  const qsCategory = qs.get('category') || null;
  const qsAccounts = qs.get('accounts') || null; // pipe-separated
    const el = (id) => document.getElementById(id);
    let lastData = { headers: [], allRows: [], sum: null };
  // Shared household: disable savings-related insights by default; enable with ?savings=on
  const disableSavings = (qs.get('savings') !== 'on');
  let selectedCategory = qsCategory || null; // active category filter (CBS main)
    let currentEditKey = null; // currently edited transaction key
  // Track last loaded URL to prevent double-loading
  window.__LAST_LOADED_DATA_URL__ = null;
  let _isInitializing = false;

    function detectDelimiter(text){ const first = text.split(/\r?\n/)[0]||''; if (first.includes('\t')) return '\t'; if (first.includes(';')) return ';'; return ','; }
    function parseTable(text){ const d=detectDelimiter(text); const lines = text.split(/\r?\n/).filter(Boolean); if(!lines.length) return { headers:[], rows:[] }; const headers=lines[0].split(d).map(h=>h.trim()); let rows=lines.slice(1).map(l=>l.split(d).map(v=>v.trim())); const headerLooksLikeData = headers.every(h => /^(\d{8}|[\d\s.,-]+|[A-Za-z0-9\-]{3,})$/.test(h)); if (headerLooksLikeData){ rows=[headers, ...rows]; return { headers:[], rows }; } return { headers, rows }; }
  function mapColumns(headers){ const idx=(names)=>headers.findIndex(h=>names.some(n=>h.toLowerCase()===n||h.toLowerCase().includes(n))); return { date: idx(['date','datum']), account: idx(['account','rekening']), description: idx(['description','omschrijving','beschrijving','description/omschrijving']), category: idx(['category','categorie']), amount: idx(['amount','bedrag','value']), mcc: idx(['mcc','merchant category code']), remittance: idx(['remittance information','remi','omschrijving2','additional information','overschrijving','sepa']), counterparty: idx(['naam tegenpartij','counterparty','name','naam']), id: idx(['id','transaction id','transactie id','transactienummer','mutatie id','mutation id','booking id','end to end id','end-to-end id','e2e id','kenmerk']) }; }
    function inferColumns(headers, rows){
      const colCount = headers.length || (rows[0]?rows[0].length:0);
      const looksDate=s=>/^\d{8}$/.test((s||'').replace(/\D/g,''));
      const looksAmount=s=>{ if(!s) return false; return /[\-+]?\d+[\.,]\d{2}$/.test((s+"").replace(/\s/g,'')); };
      const N=Math.min(rows.length,300);
      const stats=Array.from({length:colCount},()=>({amountScore:0,dateScore:0,neg:0,pos:0,text:0,numeric:0}));
      for(let r=0;r<N;r++){
        const row=rows[r]||[];
        for(let c=0;c<colCount;c++){
          const v=row[c]||'';
          if(looksAmount(v)){
            stats[c].amountScore++;
            const n=toNumber(v);
            if(n<0) stats[c].neg++;
            else if(n>0) stats[c].pos++;
          }
          if(looksDate(v)) stats[c].dateScore++;
          if(/^[\d\s.,-]+$/.test(v)) stats[c].numeric++;
          else stats[c].text++;
        }
      }
      // choose amount column: prefer one with many negatives (spend), then mixed signs
      let amount=-1, bestNeg=-1, bestMixed=-1, bestAmtScore=-1;
      for(let c=0;c<colCount;c++){
        const s=stats[c];
        if(s.amountScore>0 && s.dateScore===0){
          const mixed = (s.neg>0 && s.pos>0) ? 1 : 0;
          if(s.neg>bestNeg || (s.neg===bestNeg && mixed>bestMixed) || (s.neg===bestNeg && mixed===bestMixed && s.amountScore>bestAmtScore)){
            amount=c; bestNeg=s.neg; bestMixed=mixed; bestAmtScore=s.amountScore;
          }
        }
      }
      // choose date column: highest dateScore
      let date=-1, dateScore=-1;
      for(let c=0;c<colCount;c++){ if(stats[c].dateScore>dateScore){ dateScore=stats[c].dateScore; date=c; } }
      // choose account: pick first non-date/non-amount text-dominant column if possible
      let account=-1; let bestText=Number.NEGATIVE_INFINITY;
      for(let c=0;c<colCount;c++){
        if(c===date || c===amount) continue;
        const s=stats[c];
        const textScore = s.text - s.numeric; // prefer textual columns
        if(textScore>bestText){ bestText=textScore; account=c; }
      }
      const description=Math.max(0,colCount-1);
      return { date, account, description, category:-1, amount };
    }
    function toNumber(s){ if(typeof s!=='string') return Number(s)||0; const cleaned=s.replace(/\s/g,'').replace(/‚Ç¨/g,'').replace(/\./g,'').replace(/,/g,'.'); const n=Number(cleaned); return Number.isFinite(n)?n:0; }
    function monthKey(v){ const s=(v||'').toString(); if(/^\d{8}$/.test(s)) return `${s.slice(0,4)}-${s.slice(4,6)}`; const d=new Date(s); if(!isNaN(d)) return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; return 'unknown'; }

    // --- CBS categorization rules ---
    function normalize(s){
      const t = (s||'').toString().toLowerCase().normalize('NFD').replace(/\p{Diacritic}+/gu,'');
      return t.replace(/\s+/g,' ').trim();
    }
    // --- Local overrides (persisted in localStorage) ---
    const OV_KEY = 'cbsCategoryOverrides';
    function getOverrides(){ try{ const raw=localStorage.getItem(OV_KEY); if(!raw) return {byKey:{}, byKeyword:[]}; const o=JSON.parse(raw); return { byKey: o.byKey||{}, byKeyword: Array.isArray(o.byKeyword)?o.byKeyword:[] }; }catch{ return {byKey:{}, byKeyword:[]}; } }
    function saveOverrides(o){ localStorage.setItem(OV_KEY, JSON.stringify(o)); }
    function canonicalizeForKey(s, aggressive){
      let t = (s||'').toString().toLowerCase().normalize('NFD').replace(/\p{Diacritic}+/gu,'');
      // Remove IBAN-like tokens and long alphanumeric references when aggressive
      if (aggressive){
        t = t.replace(/nl[0-9a-z]{2}[0-9]{10,}/g,''); // crude IBAN strip
        t = t.replace(/[a-z0-9]{10,}/g,''); // long refs
        t = t.replace(/\d{5,}/g,''); // long digit sequences
      }
      // Collapse whitespace and trim
      return t.replace(/\s+/g,' ').trim();
    }
    function txnKey(row, cols){
      const aggressive = (localStorage.getItem('aggressiveDedupe') === '1');
      // Prefer explicit transaction ID when available
      if (cols.id>=0){
        const idVal = (row[cols.id]||'').toString().trim();
        if (idVal){
          const acc = cols.account>=0 ? (row[cols.account]||'') : '';
          return ['id', idVal, acc].join('|');
        }
      }
      const d = cols.date>=0 ? (row[cols.date]||'') : '';
      const a = cols.amount>=0 ? toNumber(row[cols.amount]).toFixed(2) : '0.00';
      const descRaw = cols.description>=0 ? row[cols.description] : '';
      const desc = canonicalizeForKey(descRaw, aggressive);
      const acc = cols.account>=0 ? (row[cols.account]||'') : '';
      return [d,a,desc,acc].join('|');
    }
    function applyOverrides(row, cols, desc){
      const ov=getOverrides();
      const key=txnKey(row, cols);
      if(ov.byKey[key]){
        return { main: ov.byKey[key].main, sub: ov.byKey[key].sub, via:'key' };
      }
      if(desc){
        for(const rule of ov.byKeyword){
          if(desc.includes(rule.keyword)) return { main: rule.main, sub: rule.sub, via:'keyword', keyword: rule.keyword };
        }
      }
      return null;
    }
    // Minimal MCC to main/sub mapping (extendable)
    const mccMap = {
      // Supermarkets
      '5411': { main:'Voedsel & Dranken', sub:'Boodschappen - Supermarkt' },
      // Restaurants
      '5812': { main:'Voedsel & Dranken', sub:'Restaurants & Caf√©s' }, '5814': { main:'Voedsel & Dranken', sub:'Restaurants & Caf√©s' },
      // Fuel
      '5541': { main:'Vervoer', sub:'Auto - Brandstof' }, '5542': { main:'Vervoer', sub:'Auto - Brandstof' },
      // Utilities (broad)
      '4900': { main:'Wonen', sub:'Nutsvoorzieningen - Gas & Licht' },
      // Streaming/software subscriptions (catch-all)
      '4899': { main:'Ontspanning & Cultuur', sub:'Streaming' }
    };

    function parseSEPA(row, cols){
      const raw = [cols.remittance>=0 ? row[cols.remittance] : '', cols.description>=0 ? row[cols.description] : ''].filter(Boolean).join(' | ');
      const s = normalize(raw);
      return { text: s };
    }

    const cbsRules = [
      // 0. Transfers & interne overboekingen (detect first)
      { main:'Overboekingen & Transfers', sub:'P2P / Betaalverzoek', any:["tikkie","betaalverzoek","bunq.me","revolut","splitwise"] },
      { main:'Overboekingen & Transfers', sub:'Creditcard betaling', any:["ics","international card services","visa","mastercard","amex","american express","creditcard","credit card"] },
      { main:'Overboekingen & Transfers', sub:'Interne overboeking', any:["eigen rekening","interne overboeking","interne overb","tussenrekening","spaarrekening"] },
      { main:'Overboekingen & Transfers', sub:'Lening / Loan', any:["lening","prive lening","privelening","loan"] },
      { main:'Overboekingen & Transfers', sub:'Terugbetaling / Voorgeschoten', any:["voorgeschoten","vakantiepot","retour vakantiepot","terugbetaling"] },
      { main:'Overboekingen & Transfers', sub:'Zakgeld / Kidsrekening', any:["zakgeld","kidsrekening"] },
      // 1. Wonen (Housing)
  { main:'Wonen', sub:'Huur/Hypotheek', any:["hypotheek","rente","huur","woningcorporatie","vve","vereniging van eigenaars"], dir:'out' },
  { main:'Wonen', sub:'Nutsvoorzieningen - Gas & Licht', any:["engie","vattenfall","tibber","essent","greenchoice","budget energie","energie","eneco","oxxio","vandebron","pure energie"] },
      { main:'Wonen', sub:'Nutsvoorzieningen - Water', any:["waternet","vitens","pwn","dunea","brabant water","evides","wml","waterbedrijf"] },
      { main:'Wonen', sub:'Nutsvoorzieningen - Internet/TV', any:["kpn","ziggo","xs4all","t-mobile","odido","tele2","youfone","delta","caiway","freedom internet","internet","tv","televisie"] },
      // Place Auto insurance/tax before generic insurance to avoid misclass
      { main:'Vervoer', sub:'Auto - Verzekering/Belasting', any:["wegenbelasting","motorrijtuigenbelasting","apk","autoverzekering","auto verzekering","rdw"] },
  { main:'Wonen', sub:'Onderhoud & Verzekeringen', any:["woonverzekering","inboedel","opstal","verzekering","onderhoud","reparatie","schilder","klussenbedrijf","assuradeuren","veldhuis","interpolis","unive","fbto","ohra","asr","nn ","aegon","allianz"] },

      // 2. Voedsel & Dranken
  { main:'Voedsel & Dranken', sub:'Boodschappen - Supermarkt', any:["albert heijn","ah ","jumbo","lidl","aldi","plus ","coop","spar","dirk","vomar","picnic","hoogvliet","deka","dekamarkt","jan linders","poiesz","boni","nettorama"] },
  { main:'Voedsel & Dranken', sub:'Boodschappen - Speciaal', any:["hema","gall & gall","slijter","markt","bakker","slager","kaasboer"] },
  { main:'Voedsel & Dranken', sub:'Huis & Drogist', any:["kruidvat","etos","trekpleister"] },
  { main:'Voedsel & Dranken', sub:'Restaurants & Caf√©s', any:["restaurant","cafe","bar","eetcafe","mcdonald","burger king","kfc","dominos","new york pizza","subway","la place","starbucks","delivery","takeaway","thuisbezorgd","uber eats","deliveroo","hellofresh"] },

      // 3. Vervoer
  { main:'Vervoer', sub:'Openbaar Vervoer', any:[" ns ","ns international","translink","gvb","ret","htm","connexxion","arriva","qbuzz","ov-chip","ov chip"] },
  { main:'Vervoer', sub:'Auto - Brandstof', any:["shell"," bp ","esso","total","texaco","tango","avia","tamoil","argos","firezone"] },
  { main:'Vervoer', sub:'Auto - Parkeren', any:["parkeren","parking","q-park","apcoa","parkmobile","parknow","easypark","yellowbrick"] },
      { main:'Vervoer', sub:'Auto - Deelauto', any:["greenwheels","car2go","share'n go","sharengo"] },
      { main:'Vervoer', sub:'Fiets', any:["fiets","bicycle","bike","reparatie","onderdelen"] },

      // 4. Kleding & Schoenen
      { main:'Kleding & Schoenen', sub:'Kleding & Schoenen', any:["h&m","zara","c&a","wehkamp","zalando","bijenkorf","v&d","primark","kleding","schoenen","mode","fashion"] },

      // 5. Gezondheid & Zorg
  { main:'Gezondheid & Zorg', sub:'Zorgverzekering', any:["zilveren kruis","cz "," vgz ","menzis","zorg en zekerheid","unive","fbto","ohra","ditzo","nn ","a.s.r","zorgverzekering","vinkvink"] },
      { main:'Gezondheid & Zorg', sub:'Medische Kosten', any:["apotheek","huisarts","tandarts","fysio","fysiotherapeut","specialist","ziekenhuis","medicijnen","behandeling","consult"] },

      // 6. Onderwijs & Kinderen
      { main:'Onderwijs & Kinderen', sub:'School', any:["schoolgeld","boeken","materialen","excursie","school "] },
      { main:'Onderwijs & Kinderen', sub:'Kinderopvang', any:["kinderdagverblijf","bso","oppas","cr√®che","creche"] },
      { main:'Onderwijs & Kinderen', sub:'Activiteiten', any:["sport","muziekles","hobby","vereniging"] },

      // 7. Ontspanning & Cultuur
      { main:'Ontspanning & Cultuur', sub:'Entertainment', any:["bioscoop","theater","concert","festival","museum"] },
      { main:'Ontspanning & Cultuur', sub:'Sport & Fitness', any:["sportschool","fitness","zwembad","tennis","voetbal"] },
      { main:'Ontspanning & Cultuur', sub:'Vakantie', any:["booking","airbnb","vakantie","hotel","reis","travel"] },
  { main:'Ontspanning & Cultuur', sub:'Streaming', any:["netflix","spotify","disney+","videoland","amazon prime","prime video","youtube premium","apple tv+","npo start"] },
  { main:'Ontspanning & Cultuur', sub:'Software & Abonnementen', any:["microsoft 365","office 365","adobe","icloud","google","playstation","xbox","steam","nintendo","epic games"] },

      // 8. Communicatie
      { main:'Communicatie', sub:'Telefoon', any:["telefoon","mobile","mobiel","belbundel","abonnement","kpn","vodafone","t-mobile","odido"] },

      // 9. Overige Goederen & Diensten
  { main:'Overige Goederen & Diensten', sub:'Persoonlijke Verzorging', any:["kapper","schoonheidssalon","drogist","cosmetica"] },
  { main:'Overige Goederen & Diensten', sub:'Huishoudelijke Artikelen', any:["ikea","blokker","xenos","sostrene grene","sostrene","flying tiger","gamma","karwei","praxis","hema","bol.com","coolblue"] },
  { main:'Overige Goederen & Diensten', sub:'Financi√´le Diensten', any:["bankkosten","basispakket","abn amro","advieskosten","belegging","broker","degiro","saxo","binck","peaks","meesman","brand new day","transaction fee","servicefee","service fee","paypal"] },
  // Income-specific granular rules (dir: 'in' ensures only positive amounts match)
  { main:'Inkomen', sub:'Salaris', any:["salaris","loon","payroll","hernandez ortiz b.v."], dir:'in' },
  { main:'Inkomen', sub:'Uitkering/Toeslag', any:["uwv","uitkering","toeslag","kinderbijslag"], dir:'in' },
  { main:'Inkomen', sub:'Pensioen', any:["pensioen","abp","pfzw","pensioenfonds","bpf","pmte"], dir:'in' },
  { main:'Inkomen', sub:'Rente & Dividend', any:["rente","dividend","coupon","rentebijschrijving","spaarrente","rentevergoeding"], dir:'in' },
  { main:'Inkomen', sub:'Belasting Teruggave', any:["belastingdienst","teruggave","aangifte","inkomstenbelasting","btw-teruggave","toeslagen"], dir:'in' },
  { main:'Inkomen', sub:'Huishoudbijdrage', any:["huishouden","huishouding","maandbijdrage","maand bijdrage","kidsrekening","kidsrekening maandbijdrage"], dir:'in' },
  { main:'Inkomen', sub:'Huurinkomsten', any:["huur"], dir:'in' },
  // Government and taxes (expenses only)
  { main:'Overheid & Belastingen', sub:'Belastingen & Heffingen', any:["belastingdienst","toeslagen","omzetbelasting","btw","cjib","boete","leges","gemeente"], dir:'out' },
  // Generic income catch-all (kept for backwards compatibility)
  { main:'Inkomen', sub:'Salaris & Uitkering', any:["salaris","loon","payroll","uwv","uitkering","pensioen"] },
  { main:'Onderwijs & Kinderen', sub:'DUO/Studie', any:["duo","studiefinanciering","ov-studentenkaart"] },
    ];
    function categorizeCBS(row, cols){
      const desc = normalize(cols.description>=0 ? row[cols.description] : '');
      const _sepa = parseSEPA(row, cols);
      const amt = cols.amount>=0 ? toNumber(row[cols.amount]) : 0;
      // 1) Overrides always win
      const ovr = applyOverrides(row, cols, desc);
      if (ovr){
        const src = ovr.via==='key' ? 'Override (transactie)' : `Override (keyword)`;
        const det = ovr.via==='keyword' && ovr.keyword ? `keyword "${ovr.keyword}"` : '';
        return { main: ovr.main, sub: ovr.sub, source: src, detail: det };
      }
      // 2) MCC if present
      if (cols.mcc>=0){
        const code = String(row[cols.mcc]||'').trim();
        if (mccMap[code]){
          return { ...mccMap[code], source: 'MCC', detail: code };
        }
      }
      // 3) Quick disambiguation: internet/tv
      if (/(internet|tv|televisie)/.test(desc)) return { main:'Wonen', sub:'Nutsvoorzieningen - Internet/TV', source:'Regel', detail:'internet/tv' };
      // 4) Keyword rules (match on combined SEPA+description text for better accuracy)
      const haystack = _sepa && _sepa.text ? _sepa.text : desc;
      for (const rule of cbsRules){
        if (!rule.any) continue;
    // Respect direction if provided: 'in' -> positive amounts, 'out' -> negative amounts
    if (rule.dir === 'in' && !(amt >= 0)) continue;
    if (rule.dir === 'out' && !(amt < 0)) continue;
    const hit = rule.any.find(k => haystack.includes(k));
    if (hit) return { main: rule.main, sub: rule.sub, source: 'Regel', detail: `keyword "${hit}"` };
      }
      // 4b) If positive amount and no rule matched, classify as Income by default
      if (amt >= 0){
        return { main:'Inkomen', sub:'Overig', source:'Bedrag', detail:'positief' };
      }
      // 5) Fallback
      return { main: 'Overige Goederen & Diensten', sub: 'Overig', source:'Standaard', detail: (_sepa && _sepa.text) ? 'SEPA' : '' };
    }

    // Recommended budget shares (percent of total uitgaven)
    const budgetRanges = {
      'Wonen': [30, 40],
      'Voedsel & Dranken': [10, 15],
      'Vervoer': [10, 15],
      'Kleding & Schoenen': [3, 5],
      'Gezondheid & Zorg': [3, 5],
      'Onderwijs & Kinderen': [2, 8],
      'Ontspanning & Cultuur': [5, 8],
      'Communicatie': [2, 3],
      'Overige Goederen & Diensten': [5, 10],
    };

  function summarize(headers, rows){
      let cols = mapColumns(headers);
      const noCols = [cols.date, cols.account, cols.description, cols.category, cols.amount].every(v=>v===-1);
      if (noCols || cols.amount===-1) cols = inferColumns(headers, rows);
      const monthCounts = new Map();
      rows.forEach(r=>{ const mk = cols.date>=0 ? monthKey(r[cols.date]) : 'unknown'; monthCounts.set(mk, (monthCounts.get(mk)||0)+1); });
      const months = Array.from(monthCounts.keys()).filter(m=>m!=='unknown').sort();
      let selected = el('monthSelect').value || months[months.length-1] || 'all';
      if (!el('monthSelect').value){
        if (months.length===0){ el('monthSelect').innerHTML='<option value="all">All</option>'; el('monthSelect').value='all'; selected='all'; }
        else {
          const opts = ['all', ...months];
          el('monthSelect').innerHTML = opts.map(m=>`<option value="${m}">${m==='all'?'All':m}</option>`).join('');
          el('monthSelect').value = selected;
        }
      }
      const accounts = cols.account>=0 ? Array.from(new Set(rows.map(r=>r[cols.account]).filter(Boolean))) : [];
      if (accounts.length) renderAccountChips(accounts);
      const activeAccounts = getActiveAccounts(accounts);
      // transfers toggle
      const excludeTransfers = (localStorage.getItem('excludeTransfers') === '1');
      const filtered = rows.filter(r=>{
        const okMonth=(selected==='all'||selected==='unknown'||cols.date<0)?true:(monthKey(r[cols.date])===selected);
        const okAcc = (!accounts.length || activeAccounts.has(r[cols.account]));
        if (!(okMonth && okAcc)) return false;
        if (!excludeTransfers) return true;
        const cbs = categorizeCBS(r, cols);
        return cbs.main !== 'Overboekingen & Transfers';
      });
      let income=0, expenses=0; const catAgg=new Map();
      filtered.forEach(r=>{
        const amt=toNumber(cols.amount>=0?r[cols.amount]:0);
        if(amt>=0) income+=amt; else expenses+=amt;
        const cbs = categorizeCBS(r, cols);
        const main=cbs.main || 'Overige Goederen & Diensten';
        const sub=cbs.sub || 'Overig';
        const v=catAgg.get(main)||{count:0,countIn:0,countOut:0,sum:0,income:0,expenses:0,subs:new Map()};
        v.count++; v.sum+=amt;
        if(amt>=0){ v.income += amt; v.countIn++; } else { v.expenses += amt; v.countOut++; }
        const s=v.subs.get(sub)||{count:0,sum:0}; s.count++; s.sum+=amt; v.subs.set(sub,s);
        catAgg.set(main,v);
      });
      return { income, expenses, net: income+expenses, catAgg, cols, filtered, accounts, months, selected };
    }

    function renderAccountChips(accounts){ const wrap=el('accountChips'); if(!wrap) return; if(!renderAccountChips._state){ renderAccountChips._state=new Set(accounts); } else { accounts.forEach(a=>renderAccountChips._state.add(a)); } wrap.innerHTML=''; accounts.forEach(acc=>{ const btn=document.createElement('button'); const active=renderAccountChips._state.has(acc); btn.className='btn chip ' + (active?'':'ghost'); btn.textContent=acc; btn.addEventListener('click',()=>{ if(renderAccountChips._state.has(acc)){ renderAccountChips._state.delete(acc); btn.className='btn chip ghost'; } else { renderAccountChips._state.add(acc); btn.className='btn chip'; } load(el('sourcePath').textContent); }); wrap.appendChild(btn); }); }
    function getActiveAccounts(all){ if(!renderAccountChips._state) return new Set(all); if(renderAccountChips._state.size===0) return new Set(all); return new Set(Array.from(renderAccountChips._state)); }

  function computePerAccount(sum){ const accMap=new Map(); const cols=sum.cols; sum.filtered.forEach(r=>{ const acc=cols.account>=0?(r[cols.account]||'Onbekend'):'Onbekend'; const amt=toNumber(cols.amount>=0?r[cols.amount]:0); if(!accMap.has(acc)) accMap.set(acc,{account:acc,income:0,expenses:0,net:0}); const a=accMap.get(acc); if(amt>=0) a.income+=amt; else a.expenses+=amt; a.net=a.income+a.expenses; }); return Array.from(accMap.values()).sort((a,b)=>a.account.localeCompare(b.account)); }
  function computeHistoryByMonth(allRows, cols, months, activeAccounts){ const by=new Map(); months.forEach(m=>by.set(m,{income:0, expenses:0, net:0})); const excludeTransfers = (localStorage.getItem('excludeTransfers') === '1'); allRows.forEach(r=>{ if(activeAccounts && cols.account>=0 && activeAccounts.size>0){ const acc=r[cols.account]; if(!activeAccounts.has(acc)) return; } if (excludeTransfers){ const cbs=categorizeCBS(r, cols); if (cbs.main==='Overboekingen & Transfers') return; } const m=cols.date>=0?monthKey(r[cols.date]):'unknown'; if(!by.has(m)) return; const amt=toNumber(cols.amount>=0?r[cols.amount]:0); const bucket=by.get(m); if(amt>=0) bucket.income+=amt; else bucket.expenses+=amt; bucket.net=bucket.income+bucket.expenses; }); return by; }

  function renderMonthlyBreakdown(historyByMonth, selected){ const tbody=el('monthBody'); const months=Array.from(historyByMonth.keys()).sort(); if(!months.length){ tbody.innerHTML='<tr><td colspan="5">Geen maanddata</td></tr>'; return; } const rows=months.map((m,i)=>{ const v=historyByMonth.get(m)||{income:0,expenses:0,net:0}; const prev = i>0 ? historyByMonth.get(months[i-1]) : null; const delta = prev ? (v.net - prev.net) : 0; const arrow = prev ? (delta>=0?'‚ñ≤':'‚ñº') : '‚Äì'; const deltaClass = prev ? (delta>=0?'pos':'neg') : ''; const cls=(m===selected)?'row-active':''; return `<tr class="row-click ${cls}" data-month="${m}"><td>${m}</td><td class="amount pos">${euro.format(v.income)}</td><td class="amount neg">${euro.format(Math.abs(v.expenses))}</td><td class="amount ${v.net>=0?'pos':'neg'}">${(v.net>=0?'+':'')+euro.format(v.net)}</td><td class="amount ${deltaClass}">${arrow} ${prev?(delta>=0?'+':'')+euro.format(delta):'‚Äì'}</td></tr>`; }).join(''); tbody.innerHTML=rows; Array.from(tbody.querySelectorAll('tr.row-click')).forEach(tr=>{ tr.addEventListener('click',()=>{ const m=tr.getAttribute('data-month'); el('monthSelect').value=m; load(el('sourcePath').textContent); }); }); }

    function updateHeader(sum){ el('periodLabel').textContent=sum.selected||'-'; el('lastUpdated').textContent=new Date().toLocaleString('nl-NL'); el('dataStatus').textContent='OK'; }
    function renderKPIs(sum){ el('kpiIncome').textContent=euro.format(sum.income); el('kpiExpenses').textContent=euro.format(Math.abs(sum.expenses)); const netEl=el('kpiNet'); netEl.textContent=(sum.net>=0?'+':'')+euro.format(sum.net); netEl.className='value '+(sum.net>=0?'pos':'neg'); }
  function renderCategories(sum){ const tbody=el('catBody'); const entries=Array.from(sum.catAgg.entries()); const tfoot=el('catTotalRow'); if(!entries.length){ el('catTitleDyn').textContent=`Uitgaven per Categorie - ${sum.selected||''}`; tbody.innerHTML='<tr><td colspan="5">Geen categorie-data</td></tr>'; if(tfoot) tfoot.innerHTML=''; return; } const totalNeg=entries.reduce((a,[,v])=>a+Math.abs(v.expenses||0),0); const denom=totalNeg>0?totalNeg:1; const rows=entries.sort((a,b)=>Math.abs((b[1].expenses||0)) - Math.abs((a[1].expenses||0))).map(([cat,v])=>{ const expAbs=Math.abs(v.expenses||0); const inc=v.income||0; const net=(inc + (v.expenses||0)); const countOut=v.countOut||0; const countIn=v.countIn||0; const countDisplay = (cat==='Inkomen') ? countIn : countOut; const avg=countOut>0?expAbs/countOut:0; const pct=denom>0?(expAbs/denom)*100:0; const active = (selectedCategory && selectedCategory===cat) ? ' row-active' : ''; return `<tr class=\"row-click${active}\" data-cat=\"${cat}\"><td><span class=\"category-tag\">${cat}</span></td><td>${countDisplay}</td><td class=\"amount ${net>=0?'pos':'neg'}\">${(net>=0?'+':'')+euro.format(net)}</td><td class=\"amount\">${euro.format(avg)}</td><td>${pct.toFixed(1)}%</td></tr>`; }).join(''); el('catTitleDyn').textContent=`Uitgaven per Categorie - ${sum.selected||''}`; tbody.innerHTML=rows; Array.from(tbody.querySelectorAll('tr.row-click')).forEach(tr=>{ tr.addEventListener('click',()=>{ const cat=tr.getAttribute('data-cat'); setCategoryFilter(cat); }); }); const countsDisplayedTotal = entries.reduce((acc,[cat,v])=>{ const ci=v.countIn||0; const co=v.countOut||0; return acc + (cat==='Inkomen' ? ci : co); }, 0); const totals = entries.reduce((acc,[,v])=>{ acc.inc += (v.income||0); acc.exp += Math.abs(v.expenses||0); return acc; }, {inc:0, exp:0}); const netTot = totals.inc - totals.exp; if(tfoot){ tfoot.innerHTML = `<td><strong>Totaal</strong></td><td>${countsDisplayedTotal}</td><td class=\"amount ${netTot>=0?'pos':'neg'}\">${(netTot>=0?'+':'')+euro.format(netTot)}</td><td class=\"amount\">‚Äî</td><td>100%</td>`; } }
    function renderAccounts(perAccount){ const tbody=el('acctBody'); const rows=perAccount.map(a=>`<tr><td>${a.account}</td><td class="amount pos">${euro.format(a.income)}</td><td class="amount neg">${euro.format(Math.abs(a.expenses))}</td><td class="amount ${a.net>=0?'pos':'neg'}">${(a.net>=0?'+':'')+euro.format(a.net)}</td></tr>`).join(''); tbody.innerHTML=rows||'<tr><td colspan="4">Geen data</td></tr>'; }
    function renderTransactions(headers, rows, cols){
      // Apply category filter if active
  let txRows = rows;
      if (selectedCategory){ txRows = rows.filter(r=>{ const c=categorizeCBS(r, cols); return c.main===selectedCategory; }); }
  const excludeTransfers = (localStorage.getItem('excludeTransfers') === '1');
  if (excludeTransfers){ txRows = txRows.filter(r=>{ const c=categorizeCBS(r, cols); return c.main !== 'Overboekingen & Transfers'; }); }
      const showIdx=[cols.date, cols.description, cols.category, cols.amount].filter(i=>i>=0);
      const displayHeaders=(function(){ const colCount=rows[0]?.length || headers.length || 0; let d=headers && headers.length ? headers.slice() : Array.from({length: colCount}, (_, i) => `C${i+1}`); if (cols.date>=0 && cols.date<d.length) d[cols.date]='Datum'; if (cols.description>=0 && cols.description<d.length) d[cols.description]='Beschrijving'; if (cols.category>=0 && cols.category<d.length) d[cols.category]='Categorie (Bron)'; if (cols.amount>=0 && cols.amount<d.length) d[cols.amount]='Bedrag'; if (cols.account>=0 && cols.account<d.length) d[cols.account]='Rekening'; return d; })();
  // Add CBS columns + Uitleg
  el('txHead').innerHTML = `<tr>${showIdx.map(i=>`<th>${displayHeaders[i]||'Col'}</th>`).join('')}<th>CBS Hoofdcategorie</th><th>CBS Subcategorie</th><th>Uitleg</th><th>Acties</th></tr>`;
      const max=50;
      const limited = txRows.slice(-max).reverse();
      const bodyRows = limited.map(r=>{
        const cbs = categorizeCBS(r, cols);
        const key = txnKey(r, cols);
        const tds=showIdx.map(i=>{
          if(i===cols.amount){ const val=toNumber(r[i]); return `<td class="amount ${val>=0?'pos':'neg'}">${euro.format(val)}</td>`; }
          return `<td>${r[i]||''}</td>`;
        }).join('');
        const explain = (cbs.source||'').toString();
        const detail = (cbs.detail||'').toString();
        const info = [explain, detail].filter(Boolean).join(' ‚Äî ');
        return `<tr data-key="${key}">${tds}<td>${cbs.main}</td><td>${cbs.sub}</td><td>${info||'‚Äî'}</td><td><button class="btn ghost edit-btn" data-key="${key}">Wijzig</button></td></tr>`;
      }).join('');
      const baseCols = showIdx.length + 4; // CBS main + sub + uitleg + acties
      el('txBody').innerHTML = bodyRows || `<tr><td colspan="${baseCols}">Geen transacties</td></tr>`;
      // Wire edit buttons
      Array.from(el('txBody').querySelectorAll('.edit-btn')).forEach(btn=>{
        btn.addEventListener('click', (e)=>{ const key=e.currentTarget.getAttribute('data-key'); openEditModalForKey(key); });
      });
      renderTxFilterBar();
    }

    function buildDisplayHeaders(headers, cols){ const colCount=lastData.sum?.filtered?.[0]?.length || headers.length || 0; let display=headers && headers.length ? headers.slice() : Array.from({length: colCount}, (_, i) => `C${i+1}`); if (cols.date>=0 && cols.date<display.length) display[cols.date]='Date'; if (cols.account>=0 && cols.account<display.length) display[cols.account]='Account'; if (cols.description>=0 && cols.description<display.length) display[cols.description]='Description'; if (cols.category>=0 && cols.category<display.length) display[cols.category]='Category'; if (cols.amount>=0 && cols.amount<display.length) display[cols.amount]='Amount'; return display; }
    function toCSV(rows){ return rows.map(r=>r.map(v=>{ const s=(v??'').toString(); if(/[",\n;\t]/.test(s)) return '"'+s.replace(/"/g,'""')+'"'; return s; }).join(',')).join('\n'); }
    function downloadCSV(csvText, filename){ const blob=new Blob([csvText],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); }
    function exportTransactionsCSV(){ if(!lastData.sum) return; const { headers, sum } = lastData; const cols=sum.cols; const rows=sum.filtered?.length?sum.filtered:lastData.allRows; const headerRow=buildDisplayHeaders(headers, cols); const addMonth=cols && cols.date>=0; const out=[]; out.push(addMonth?[...headerRow,'Month']:headerRow); for(const r of rows){ const m=addMonth?monthKey(r[cols.date]):undefined; out.push(addMonth?[...r,m]:r); } const csv=toCSV(out); const month=sum.selected||'all'; downloadCSV(csv, `transactions_${month}.csv`); }
  function exportCategoriesCSV(){ if(!lastData.sum) return; const entries=Array.from(lastData.sum.catAgg.entries()).sort((a,b)=>Math.abs(b[1].sum)-Math.abs(a[1].sum)); const out=[["Main Category","Count","Amount","Top Subcategory"]]; for(const [cat,v] of entries){ const topSub = Array.from((v.subs||new Map()).entries()).sort((a,b)=>Math.abs(b[1].sum)-Math.abs(a[1].sum))[0]?.[0] || ''; out.push([cat, String(v.count), v.sum.toFixed(2), topSub]); } const csv=toCSV(out); const month=lastData.sum.selected||'all'; downloadCSV(csv, `categories_${month}.csv`); }

    function generateInsights(sum, perAccount, historyByMonth){
      const insights=[];
      // Savings rate (disabled by default for shared household accounts)
      if (!disableSavings){
        const income = sum.income; const spend = Math.abs(sum.expenses); const savings = sum.net;
        if (income > 0){ const rate = (savings / income) * 100; if (rate < 10) insights.push({title:'Verhoog je spaarpercentage', text:`Je spaarpercentage is ${rate.toFixed(1)}%. Mik op 10‚Äì20% door vaste lasten te optimaliseren en variabele uitgaven te beperken.`}); else insights.push({title:'Mooi spaarpercentage', text:`Je spaart ${rate.toFixed(1)}% van je inkomen. Houd dit niveau vast.`}); }
      }
      // Top category spend
      const topCat = Array.from(sum.catAgg.entries()).filter(([,v])=>v.sum<0).sort((a,b)=>Math.abs(b[1].sum)-Math.abs(a[1].sum))[0];
      if (topCat){ const [cat,v]=topCat; insights.push({title:`Grootste uitgavencategorie: ${cat}` , text:`Overweeg een budgetplafond. Gemiddeld per transactie: ${euro.format(Math.abs(v.sum)/(v.count||1))}.`}); }
      // Account at risk
      const worstAcc = perAccount.slice().sort((a,b)=>a.net-b.net)[0];
      if (worstAcc && worstAcc.net < 0){ insights.push({title:`Account in het rood: ${worstAcc.account}`, text:`Netto deze maand: ${(worstAcc.net>=0?'+':'')+euro.format(worstAcc.net)}. Overweeg interne overboeking of uitgavenbeperking.`}); }
      // Month-over-month change (if history available)
      const months = Array.from(historyByMonth.keys()).sort(); const idx = months.indexOf(sum.selected);
      if (idx > 0){ const curr=historyByMonth.get(months[idx]); const prev=historyByMonth.get(months[idx-1]); if (curr && prev){ const delta = (curr.net - prev.net); const trend = delta>=0 ? 'verbeterd' : 'verslechterd'; insights.push({title:'Maand-op-maand', text:`Netto resultaat is ${trend} met ${delta>=0?'+':''}${euro.format(delta)} t.o.v. vorige maand.`}); } }
      // Fixed costs heuristic: if categories contain common fixed labels
      const fixedKeys=['huur','hypotheek','verzekering','energy','stroom','gas','water','telecom','internet'];
      const fixedSpend = Array.from(sum.catAgg.entries()).filter(([k,v])=> v.sum<0 && fixedKeys.some(key=> (k||'').toLowerCase().includes(key))).reduce((a,[,v])=>a+Math.abs(v.sum),0);
      if (fixedSpend>0){ insights.push({title:'Optimaliseer vaste lasten', text:`Je vaste lasten zijn circa ${euro.format(fixedSpend)}. Kijk naar energiecontracten en verzekeringen voor mogelijke besparingen.`}); }

      // Budget share checks against CBS recommendations (percent of total uitgaven)
      const entries = Array.from(sum.catAgg.entries());
      const totalNeg = entries.reduce((a,[,v])=> a + (v.sum<0?Math.abs(v.sum):0), 0) || 1;
      for (const [main,v] of entries){
        if (v.sum >= 0) continue; // only expenses
        const pct = (Math.abs(v.sum)/totalNeg)*100;
        const range = budgetRanges[main];
        if (!range) continue;
        const [low, high] = range;
        if (pct > high) insights.push({ title:`${main} boven richtlijn`, text:`${main} is ${pct.toFixed(1)}% van je uitgaven (richtlijn ${low}-${high}%). Zoek optimalisaties of stel een limiet.` });
        else if (pct < low) insights.push({ title:`${main} lager dan verwacht`, text:`${main} is ${pct.toFixed(1)}% (richtlijn ${low}-${high}%). Controleer of uitgaven correct gecategoriseerd zijn.` });
      }
      return insights;
    }

    // Helpers: recompute and render without refetch
    function recomputeAndRender(){ if(!lastData || !lastData.allRows) return; const { headers, allRows } = lastData; const sum = summarize(headers, allRows); lastData.sum = sum; const perAccount = computePerAccount(sum); const history = computeHistoryByMonth(allRows, sum.cols, sum.months, getActiveAccounts(sum.accounts||[])); updateHeader(sum); renderKPIs(sum); renderCategories(sum); renderAccounts(perAccount); renderMonthlyBreakdown(history, sum.selected); renderTransactions(headers, sum.filtered, sum.cols); const insightItems = generateInsights(sum, perAccount, history).map(i=>`<div class=\"insight\"><strong>${i.title}</strong><div class=\"muted\">${i.text}</div></div>`).join(''); el('insightList').innerHTML = insightItems || '<div class="muted">Nog geen aanbevelingen</div>'; }

    function setCategoryFilter(cat){ selectedCategory = cat; recomputeAndRender(); const sec=document.getElementById('transactionsSection'); if(sec) sec.scrollIntoView({ behavior:'smooth', block:'start' }); }
    function clearCategoryFilter(){ selectedCategory = null; recomputeAndRender(); }

    function renderTxFilterBar(){ const bar = el('txFilterBar'); if(!bar) return; if(selectedCategory){ bar.innerHTML = `<span class="filter-pill">Filter: ${selectedCategory} <span class="clear" title="Wis filter">√ó</span></span>`; bar.querySelector('.clear').addEventListener('click', clearCategoryFilter); } else { bar.innerHTML=''; } }

    // --- GoCardless sync helpers ---
    async function runSync(){
      try{
        el('dataStatus').textContent='syncing‚Ä¶';
        const res = await fetch('/api/sync/run', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({}) });
        const js = await res.json();
        if (!res.ok || js.ok === false){ throw new Error(js?.error || 'Sync start failed'); }
        // brief poll of status
        await pollSyncStatus(5);
        el('dataStatus').textContent='OK';
      } catch(e){
        el('dataStatus').textContent='error';
        alert('Sync mislukt: ' + e.message);
      }
    }
    async function pollSyncStatus(tries=5){
      for(let i=0;i<tries;i++){
        const r = await fetch('/api/sync/status', { cache:'no-store' });
        const s = await r.json();
        if (s && s.running){ el('dataStatus').textContent='syncing‚Ä¶'; await new Promise(t=>setTimeout(t, 1500)); continue; }
        // if finished and lastUpdated exists, refresh header label from synced file
        try{
          const sj = await (await fetch('/data/synced_transactions.json?_ts='+Date.now(), { cache:'no-store' })).json();
          if (sj && sj.lastUpdated){ el('lastUpdated').textContent = new Date(sj.lastUpdated).toLocaleString('nl-NL'); }
        }catch{}
        break;
      }
    }

    function getAllMains(){ const set=new Set(Object.keys(budgetRanges)); cbsRules.forEach(r=>set.add(r.main)); return Array.from(set); }

    function openEditModalForKey(key){ currentEditKey = key; const rows = lastData?.allRows || []; const cols = lastData?.sum?.cols || {}; const row = rows.find(r=> txnKey(r, cols) === key); if(!row){ alert('Transactie niet gevonden'); return; } const desc = cols.description>=0 ? (row[cols.description]||'') : ''; const cbs = categorizeCBS(row, cols); // pre-fill
      // fill selects
      const mainSel = el('editMain'); mainSel.innerHTML = getAllMains().map(m=>`<option value="${m}">${m}</option>`).join(''); mainSel.value = cbs.main;
      el('editSub').value = cbs.sub || '';
      el('editDesc').textContent = desc;
      el('editApplyKeyword').checked = false; el('editKeyword').value='';
      el('editModal').classList.add('show');
    }

    function closeEditModal(){ el('editModal').classList.remove('show'); currentEditKey=null; }

    function persistEdit(){ const cols = lastData?.sum?.cols || {}; const rows = lastData?.allRows || []; if(!currentEditKey){ closeEditModal(); return; } const row = rows.find(r=> txnKey(r, cols) === currentEditKey); if(!row){ closeEditModal(); return; } const main = el('editMain').value || 'Overige Goederen & Diensten'; const sub = el('editSub').value || 'Overig'; const applyByKeyword = el('editApplyKeyword').checked; const keywordRaw = el('editKeyword').value.trim(); const ov = getOverrides(); if(applyByKeyword){ if(!keywordRaw){ alert('Vul een trefwoord in of kies "alleen deze transactie".'); return; } ov.byKeyword.push({ keyword: normalize(keywordRaw), main, sub }); } else { ov.byKey[currentEditKey] = { main, sub }; }
      saveOverrides(ov); closeEditModal(); recomputeAndRender(); }

    // Rules manager
    function openRulesModal(){ renderRulesLists(); el('rulesModal').classList.add('show'); }
    function closeRulesModal(){ el('rulesModal').classList.remove('show'); }
    function renderRulesLists(){ const ov=getOverrides(); const kwBody=el('kwRulesBody'); const keyBody=el('keyRulesBody');
      kwBody.innerHTML = (ov.byKeyword.length? ov.byKeyword.map((r,i)=>`<tr><td>${r.keyword}</td><td>${r.main}</td><td>${r.sub}</td><td><button class=\"btn ghost\" data-idx=\"${i}\" data-type=\"kw\">Verwijder</button></td></tr>`).join('') : '<tr><td colspan="4" class="muted">Geen trefwoordregels</td></tr>');
      const keys = Object.keys(ov.byKey||{});
      keyBody.innerHTML = (keys.length? keys.map(k=>{ const v=ov.byKey[k]; return `<tr><td style="font-family:monospace; font-size:.85rem;">${k}</td><td>${v.main}</td><td>${v.sub}</td><td><button class=\"btn ghost\" data-key=\"${k}\" data-type=\"key\">Verwijder</button></td></tr>`; }).join('') : '<tr><td colspan="4" class="muted">Geen transactie-specifieke regels</td></tr>');
      // wire remove buttons
      kwBody.querySelectorAll('button[data-type="kw"]').forEach(b=> b.addEventListener('click', ()=>{ const idx=Number(b.getAttribute('data-idx')); removeKeywordRule(idx); }));
      keyBody.querySelectorAll('button[data-type="key"]').forEach(b=> b.addEventListener('click', ()=>{ const k=b.getAttribute('data-key'); removeKeyRule(k); }));
    }
    function removeKeywordRule(idx){ const ov=getOverrides(); if(idx>=0 && idx<ov.byKeyword.length){ ov.byKeyword.splice(idx,1); saveOverrides(ov); renderRulesLists(); recomputeAndRender(); } }
    function removeKeyRule(k){ const ov=getOverrides(); if(ov.byKey && ov.byKey[k]){ delete ov.byKey[k]; saveOverrides(ov); renderRulesLists(); recomputeAndRender(); } }
    function clearAllOverrides(){ if(!confirm('Weet je zeker dat je alle regels wilt wissen?')) return; saveOverrides({byKey:{}, byKeyword:[]}); renderRulesLists(); recomputeAndRender(); }

  let _appliedMonthParam = false;
  async function renderFromText(text, label){
      try{
        el('dataStatus').textContent='parsing‚Ä¶'; el('sourcePath').textContent=label;
  let { headers, rows } = parseTable(text);
        // Try to merge GoCardless synced JSON if present
        try{
          const sj = await (await fetch('/data/synced_transactions.json?_ts='+Date.now(), { cache:'no-store' })).json();
          if (sj && Array.isArray(sj.transactions) && sj.transactions.length){
            const gcRows = sj.transactions.map(tx => {
              const d = tx.date || tx.bookingDate || tx.valueDate || '';
              const yyyymmdd = (d && /^\d{4}-\d{2}-\d{2}$/.test(d)) ? d.replace(/-/g,'') : (new Date(d) instanceof Date && !isNaN(new Date(d)) ? `${new Date(d).getFullYear()}${String(new Date(d).getMonth()+1).padStart(2,'0')}${String(new Date(d).getDate()).padStart(2,'0')}` : '');
              const amt = (tx.amount!=null?tx.amount:(tx.transactionAmount?.amount));
              const desc = tx.description || tx.remittanceInformationUnstructured || (Array.isArray(tx.remittanceInformationUnstructuredArray)?tx.remittanceInformationUnstructuredArray.join(' '):'') || tx.creditorName || tx.debtorName || '';
              const acc = tx.accountId || tx.iban || 'GoCardless';
              return [acc, yyyymmdd, desc, String(amt ?? '')];
            });
            rows = rows.concat(gcRows);
            if (sj.lastUpdated){ el('lastUpdated').textContent = new Date(sj.lastUpdated).toLocaleString('nl-NL'); }
          }
        } catch {}
        if(!rows.length) throw new Error('No rows');
        // Basic validation + deduplication
        // Determine column mapping early so we can build stable transaction keys for dedupe
        let preCols = mapColumns(headers);
        const needInfer = [preCols.amount].some(v=>v===-1);
        if (needInfer) preCols = inferColumns(headers, rows);
        if (preCols.amount === -1){
          // Without an amount column, categorization and net calculations are unreliable
          console.warn('Geen kolom voor bedrag gevonden; resultaten kunnen onnauwkeurig zijn.');
        } else {
          // Dedupe across all rows (including any merged synced rows) by (date|amount|desc|account)
          const seen = new Set();
          const dedup = [];
          let removed = 0;
          for (const r of rows){
            const key = txnKey(r, preCols);
            if (!seen.has(key)){ seen.add(key); dedup.push(r); } else { removed++; }
          }
          rows = dedup;
          if (removed>0){
            const badge = document.getElementById('dataStatus');
            if (badge){ badge.textContent = `OK ‚Ä¢ dedupe: ${removed}`; }
          }
        }
  const sum = summarize(headers, rows);
        lastData = { headers, allRows: rows, sum };
        const perAccount = computePerAccount(sum);
        const history = computeHistoryByMonth(rows, sum.cols, sum.months, getActiveAccounts(sum.accounts||[]));

        updateHeader(sum);
        renderKPIs(sum);
        renderCategories(sum);
        renderAccounts(perAccount);
        renderMonthlyBreakdown(history, sum.selected);
        renderTransactions(headers, sum.filtered, sum.cols);
        const insightItems = generateInsights(sum, perAccount, history).map(i=>`<div class=\"insight\"><strong>${i.title}</strong><div class=\"muted\">${i.text}</div></div>`).join('');
        el('insightList').innerHTML = insightItems || '<div class="muted">Nog geen aanbevelingen</div>';
        el('dataStatus').textContent='OK';
      } catch(e){ el('dataStatus').textContent='error'; alert('Kon data niet laden: ' + e.message); }
    }

  async function load(url){
      // Skip if already loaded this exact URL (prevent double-load race)
      if (window.__LAST_LOADED_DATA_URL__ === url) {
        return;
      }
      try{
        el('dataStatus').textContent='loading‚Ä¶'; el('sourcePath').textContent=url;
        const bust = (url.includes('?')?'&':'?') + '_ts=' + Date.now();
        const res = await fetch(url + bust, { cache:'no-store' });
        if (!res.ok) throw new Error('HTTP '+res.status);
        const text = await res.text();
        await renderFromText(text, url);
        // Mark as successfully loaded
        window.__LAST_LOADED_DATA_URL__ = url;
        // Apply deep-link month param once if valid (after initial load only)
        if (qsMonth && !_appliedMonthParam){
          if (sum.months && sum.months.includes(qsMonth)){
            el('monthSelect').value = qsMonth;
            _appliedMonthParam = true;
            recomputeAndRender();
          } else {
            _appliedMonthParam = true; // avoid loops even if invalid
          }
        }
      } catch(e){
        el('dataStatus').textContent='error';
        alert('Kon data niet laden: ' + e.message);
      }
    }

    // Wire
    document.addEventListener('DOMContentLoaded', function(){
      // Guard against re-entrancy during initialization
      if (_isInitializing) return;
      _isInitializing = true;
      // Pre-apply accounts filter from query param
      if (qsAccounts){
        const list = qsAccounts.split('|').map(s=>s.trim()).filter(Boolean);
        if (list.length){ renderAccountChips._state = new Set(list); }
      }
      load(dataUrl);
      el('reloadBtn').addEventListener('click', ()=>load(el('sourcePath').textContent));
  const sb = el('syncBtn'); if (sb){ sb.addEventListener('click', runSync); }
      el('loadBtn').addEventListener('click', ()=>{ const u=el('customUrl').value.trim(); if(u) load(u); });
      const fi = document.getElementById('fileInput');
      if (fi){
        fi.addEventListener('change', async (e)=>{
          const file = e.target.files && e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = async () => { await renderFromText(reader.result, file.name); };
          reader.onerror = () => { alert('Kon bestand niet lezen'); };
          reader.readAsText(file);
        });
      }
      // Drag & drop support
      document.addEventListener('dragover', (e)=>{ e.preventDefault(); });
      document.addEventListener('drop', (e)=>{
        e.preventDefault();
        const file = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async () => { await renderFromText(reader.result, file.name); };
        reader.onerror = () => { alert('Kon bestand niet lezen'); };
        reader.readAsText(file);
      });
      el('monthSelect').addEventListener('change', ()=>load(el('sourcePath').textContent));
      el('exportTxBtn').addEventListener('click', exportTransactionsCSV);
      el('exportCatBtn').addEventListener('click', exportCategoriesCSV);
  // init exclude transfers toggle
  const ex = document.getElementById('excludeTransfers');
  if (ex){ ex.checked = localStorage.getItem('excludeTransfers') === '1'; ex.addEventListener('change', ()=>{ localStorage.setItem('excludeTransfers', ex.checked ? '1' : '0'); recomputeAndRender(); }); }
      // modal buttons
      el('editCancel').addEventListener('click', closeEditModal);
      el('editSave').addEventListener('click', persistEdit);
      // close modal on overlay click
      el('editModal').addEventListener('click', (e)=>{ if(e.target===el('editModal')) closeEditModal(); });
  // rules manager
  el('rulesBtn').addEventListener('click', openRulesModal);
  el('rulesClose').addEventListener('click', closeRulesModal);
  el('rulesModal').addEventListener('click', (e)=>{ if(e.target===el('rulesModal')) closeRulesModal(); });
  el('rulesClear').addEventListener('click', clearAllOverrides);
      // Help menu wiring
      const helpMenuBtn = document.getElementById('helpMenuBtn');
      const helpMenu = document.getElementById('helpMenu');
      if (helpMenuBtn && helpMenu){
        helpMenuBtn.addEventListener('click', (e)=>{
          e.stopPropagation();
          helpMenu.style.display = helpMenu.style.display === 'none' ? 'block' : 'none';
        });
        document.addEventListener('click', (e)=>{
          if (!helpMenu.contains(e.target) && e.target !== helpMenuBtn){ helpMenu.style.display = 'none'; }
        });
        document.getElementById('resetFiltersLink').addEventListener('click', (e)=>{
          e.preventDefault();
          // Reset month
          const ms = document.getElementById('monthSelect'); if (ms){ ms.value = 'all'; }
          // Reset accounts: remove specific selection so next render selects all
          renderAccountChips._state = null;
          // Clear category filter
          selectedCategory = null;
          // Clear deep-link params including savings
          const url = new URL(window.location.href);
          ['month','category','accounts','savings'].forEach(p=>url.searchParams.delete(p));
          window.history.replaceState({}, '', url.toString());
          recomputeAndRender();
          helpMenu.style.display = 'none';
        });
        document.getElementById('openRulesLink').addEventListener('click', (e)=>{
          e.preventDefault();
          openRulesModal();
          helpMenu.style.display = 'none';
        });
        document.getElementById('aboutLink').addEventListener('click', (e)=>{
          e.preventDefault();
          alert('Unified Dashboard\n- Diepe koppelingen: data, month, category, accounts, savings\n- Pas categorie√´n aan via ‚öôÔ∏è Beheer regels of Wijzig-knoppen.');
          helpMenu.style.display = 'none';
        });
      }
    });
  </script>
</body>
</html>
